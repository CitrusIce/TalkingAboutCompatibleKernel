
<!-- saved from url=(0098)https://web.archive.org/web/20180504221210/http://www.longene.org/techdoc/0562505001224576771.html -->
<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="Content-Type" content="text/html; charset=gb18030"><script src="./漫谈兼容内核之十二__files/analytics.js.下载" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app216.us.archive.org';v.server_ms=327;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="./漫谈兼容内核之十二__files/bundle-playback.js.下载" charset="utf-8"></script>
<script type="text/javascript" src="./漫谈兼容内核之十二__files/wombat.js.下载" charset="utf-8"></script>
<script type="text/javascript">
  __wm.init("https://web.archive.org/web");
  __wm.wombat("http://www.longene.org:80/techdoc/0562505001224576771.html","20180504221210","https://web.archive.org/","web","/_static/",
	      "1525471930");
</script>
<link rel="stylesheet" type="text/css" href="./漫谈兼容内核之十二__files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="./漫谈兼容内核之十二__files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->


<meta name="ProgId" content="Word.Document">
<meta name="Generator" content="Microsoft Word 11">
<meta name="Originator" content="Microsoft Word 11">
<link rel="File-List" href="https://web.archive.org/web/20180504221210/http://www.longene.org/techdoc/0562505001224576771.files/filelist.xml">
<title>漫谈兼容内核之十二:</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>tt</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>SYSTEM</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>3664</o:TotalTime>
  <o:Created>2008-10-21T08:12:00Z</o:Created>
  <o:LastSaved>2008-10-21T08:12:00Z</o:LastSaved>
  <o:Pages>3</o:Pages>
  <o:Words>4464</o:Words>
  <o:Characters>25446</o:Characters>
  <o:Lines>212</o:Lines>
  <o:Paragraphs>59</o:Paragraphs>
  <o:CharactersWithSpaces>29851</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:HideSpellingErrors/>
  <w:ActiveWritingStyle Lang="ZH-CN" VendorID="64" DLLVersion="131077"
   NLCheck="1">1</w:ActiveWritingStyle>
  <w:ActiveWritingStyle Lang="EN-US" VendorID="64" DLLVersion="131077"
   NLCheck="1">1</w:ActiveWritingStyle>
  <w:GrammarState>Clean</w:GrammarState>
  <w:PunctuationKerning/>
  <w:DrawingGridVerticalSpacing>7.8 磅</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>2</w:DisplayVerticalDrawingGridEvery>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:SpaceForUL/>
   <w:BalanceSingleByteDoubleByteWidth/>
   <w:DoNotLeaveBackslashAlone/>
   <w:ULTrailSpace/>
   <w:DoNotExpandShiftReturn/>
   <w:AdjustLineHeightInTable/>
   <w:SelectEntireFieldWithStartOrEnd/>
   <w:UseWord2002TableStyleRules/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:隶书;
	panose-1:2 1 5 9 6 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:1 135135232 16 0 262144 0;}
@font-face
	{font-family:"\@隶书";
	panose-1:2 1 5 9 6 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:1 135135232 16 0 262144 0;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:宋体;
	mso-font-kerning:1.0pt;}
h1
	{mso-style-next:正文;
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	page-break-after:avoid;
	mso-outline-level:1;
	tab-stops:144.0pt;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
span.docemphasis
	{mso-style-name:docemphasis;}
span.programelement
	{mso-style-name:programelement;}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:42.55pt;
	mso-footer-margin:49.6pt;
	mso-paper-source:0;
	layout-grid:15.6pt;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:24791233;
	mso-list-type:hybrid;
	mso-list-template-ids:-1550824996 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l1
	{mso-list-id:48769839;
	mso-list-type:hybrid;
	mso-list-template-ids:1224260682 -738544912 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l1:level1
	{mso-level-tab-stop:60.0pt;
	mso-level-number-position:left;
	margin-left:60.0pt;
	text-indent:-18.0pt;}
@list l2
	{mso-list-id:50546113;
	mso-list-type:hybrid;
	mso-list-template-ids:1876741048 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l2:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l3
	{mso-list-id:244842798;
	mso-list-type:hybrid;
	mso-list-template-ids:-395799204 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l3:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:21.0pt;
	mso-level-number-position:left;
	margin-left:21.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l4
	{mso-list-id:973951326;
	mso-list-type:hybrid;
	mso-list-template-ids:493242828 -738544912 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l4:level1
	{mso-level-tab-stop:60.0pt;
	mso-level-number-position:left;
	margin-left:60.0pt;
	text-indent:-18.0pt;}
@list l5
	{mso-list-id:1004359038;
	mso-list-type:hybrid;
	mso-list-template-ids:1363475660 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l5:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:21.0pt;
	mso-level-number-position:left;
	margin-left:21.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l6
	{mso-list-id:1078677497;
	mso-list-type:hybrid;
	mso-list-template-ids:-1959094908 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l6:level1
	{mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;}
@list l7
	{mso-list-id:1285228769;
	mso-list-type:hybrid;
	mso-list-template-ids:-2023748340 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l7:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l8
	{mso-list-id:1336957897;
	mso-list-type:hybrid;
	mso-list-template-ids:-494783560 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l8:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l9
	{mso-list-id:1369796687;
	mso-list-type:hybrid;
	mso-list-template-ids:-2084822378 -895033128 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l9:level1
	{mso-level-text:%1）;
	mso-level-tab-stop:57.0pt;
	mso-level-number-position:left;
	margin-left:57.0pt;
	text-indent:-36.0pt;}
@list l10
	{mso-list-id:1780830494;
	mso-list-type:hybrid;
	mso-list-template-ids:863028420 -2143931400 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l10:level1
	{mso-level-number-format:alpha-lower;
	mso-level-tab-stop:81.0pt;
	mso-level-number-position:left;
	margin-left:81.0pt;
	text-indent:-18.0pt;}
@list l11
	{mso-list-id:2091805927;
	mso-list-type:hybrid;
	mso-list-template-ids:1876741048 67698703 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l11:level1
	{mso-level-tab-stop:42.0pt;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;}
@list l12
	{mso-list-id:2146005750;
	mso-list-type:hybrid;
	mso-list-template-ids:938895032 -738544912 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l12:level1
	{mso-level-tab-stop:81.0pt;
	mso-level-number-position:left;
	margin-left:81.0pt;
	text-indent:-18.0pt;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:普通表格;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
<style>hcfy-result.__hcfy__result__loaded__.__hcfy__result__both__{border: 1px dotted}</style></head>

<body lang="ZH-CN" style="tab-interval:21.0pt;text-justify-trim:punctuation"><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" lang="en" style="display: block; direction: ltr;">
</div><div id="wm-ipp-print">The Wayback Machine - https://web.archive.org/web/20180504221210/http://www.longene.org:80/techdoc/0562505001224576771.html</div>
<script type="text/javascript">
__wm.bt(675,27,25,2,"web","http://www.longene.org/techdoc/0562505001224576771.html","20180504221210",1996,"/_static/",["/_static/css/banner-styles.css?v=fantwOh2","/_static/css/iconochive.css?v=qtvMKcIJ"], false);
  __wm.rw(1);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

<div class="Section1" style="layout-grid:15.6pt">

<p class="MsoNormal" align="center" style="text-align:center"><b><span style="font-size:18.0pt;mso-bidi-font-size:12.0pt;font-family:宋体;mso-ascii-font-family:
隶书;mso-hansi-font-family:&quot;Times New Roman&quot;">漫谈兼容内核之十二</span></b><b><span lang="EN-US" style="font-size:18.0pt;mso-bidi-font-size:12.0pt;font-family:隶书;
mso-fareast-font-family:宋体">:</span></b><b><span lang="EN-US" style="font-size:
22.0pt;mso-bidi-font-size:12.0pt"><o:p></o:p></span></b></p>

<p class="MsoNormal" align="center" style="text-align:center"><b><span lang="EN-US" style="font-size:22.0pt;mso-bidi-font-size:12.0pt">Windows</span></b><b><span style="font-size:22.0pt;mso-bidi-font-size:12.0pt;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的</span></b><b><span lang="EN-US" style="font-size:22.0pt;mso-bidi-font-size:12.0pt">APC</span></b><b><span style="font-size:22.0pt;mso-bidi-font-size:12.0pt;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">机制</span></b><b><span lang="EN-US" style="font-size:22.0pt;mso-bidi-font-size:12.0pt"><o:p></o:p></span></b></p>

<p class="MsoNormal" align="center" style="text-align:center"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">毛德操</span></p>

<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">前两篇漫谈中讲到，除</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">外，在启动一个新进程运行时，</span><span lang="EN-US">PE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">格式</span><span lang="EN-US">DLL</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">映像的装入和动态连接是由</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中的函数</span><span class="docemphasis"><span lang="EN-US">LdrInitializeThunk()</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">作为</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数执行而完成的。这就牵涉到了</span><span lang="EN-US">Windows</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">机制，</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">是“异步过程调用</span><span lang="EN-US">(Asyncroneus Procedure Call)</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">”的缩写。从大体上说，</span><span lang="EN-US">Windows</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">的</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">机制相当于</span><span lang="EN-US">Linux</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">的</span><span lang="EN-US">Signal</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">机制，实质上是一种对于应用软件</span><span lang="EN-US">(</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">线程</span><span lang="EN-US">)</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的“软件中断”机制。但是读者将会看到，</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">机制至少在形式上与软件中断机制还是有相当的区别，而称之为“异步过程调用”确实更为贴切。</span><span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span class="docemphasis"><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">与系统调用是密切连系在一起的，</span></span><span style="font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">在这个意义上</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">是系统调用界面的一部分。然而</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">又与设备驱动有着很密切的关系。例如，</span><span lang="EN-US">ntddk.h</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中提供“写文件”系统调用</span><span lang="EN-US">ZwWriteFile()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、即</span><span lang="EN-US">NtWriteFile()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的调用界面为：</span></p>

<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal"><span lang="EN-US">NTSYSAPI</span></p>

<p class="MsoNormal"><span lang="EN-US">NTSTATUS</span></p>

<p class="MsoNormal"><span lang="EN-US">NTAPI</span></p>

<p class="MsoNormal"><span lang="EN-US">ZwWriteFile(</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN HANDLE FileHandle,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN HANDLE Event OPTIONAL,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN PIO_APC_ROUTINE <b>ApcRoutine</b>
OPTIONAL,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN PVOID <b>ApcContext</b>
OPTIONAL,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>OUT PIO_STATUS_BLOCK
IoStatusBlock,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN PVOID Buffer,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN ULONG Length,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN PLARGE_INTEGER ByteOffset
OPTIONAL,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>IN PULONG Key OPTIONAL</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>);</span></p>

<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">这里有个参数</span><span lang="EN-US">ApcRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，这是一个函数指针。什么时候要用到这个指针呢？原来，文件操作有“同步”和“异步”之分。普通的写文件操作是同步写，启动这种操作的线程在内核进行写文件操作期间被“阻塞</span><span lang="EN-US">(blocked)</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">”而进入“睡眠”，直到设备驱动完成了操作以后才又将该线程“唤醒”而从系统调用返回。但是，如果目标文件是按异步操作打开的，即在通过</span><span lang="EN-US">W32</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">的</span><span lang="EN-US">API</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数</span><span lang="EN-US">CreateFile()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">打开目标文件时把调用参数</span><span lang="EN-US">dwFlagsAndAttributes</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">设置成</span><span lang="EN-US">FILE_FLAG_OVERLAPPED</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，那么调用者就不会被阻塞，而是把事情交给内核、不等实际的操作完成就返回了。但是此时要把</span><span lang="EN-US">ApcRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">设置成指向某个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数。这样，当设备驱动完成实际的操作时，就会使调用者线程执行这个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数，就像是发生了一次中断。执行该</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数时的调用界面为：</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal"><span lang="EN-US">typedef</span></p>

<p class="MsoNormal"><span lang="EN-US">VOID</span></p>

<p class="MsoNormal"><span lang="EN-US">(NTAPI *PIO_APC_ROUTINE) (IN PVOID
ApcContext,</span></p>

<p class="MsoNormal"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PIO_STATUS_BLOCK IoStatusBlock, IN ULONG Reserved);</span></p>

<p class="MsoNormal"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">这里的指针</span><span lang="EN-US">ApcContext</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">就是</span><span lang="EN-US">NtWriteFile()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">调用界面上传下来的，至于作什么解释、起什么作用，那是包括</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数在内的用户软件自己的事，内核只是把它传递给</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">在这个过程中，把</span><span lang="EN-US">ApcRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">设置成指向</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数相当于登记了一个中断服务程序，而设备驱动在完成实际的文件操作后就向调用者线程发出相当于中断请求的“</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求”，使其执行这个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">从这个角度说，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制又应该说是设备驱动框架的一部分。事实上，读者以后还会看到，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制与设备驱动的关系比这里所见的还要更加密切。此外，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制与异常处理的关系也很密切。</span><span class="docemphasis"><span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">不仅内核可以向一个线程发出</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求，别的线程、乃至目标线程自身也可以发出这样的请求。</span><span lang="EN-US">Windows</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">为应用程序提供了一个函数</span><span lang="EN-US">QueueUserAPC()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，就是用于此项目的，下面是</span><span lang="EN-US">ReactOS</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中这个函数的代码：</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">DWORD STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">QueueUserAPC</span></b><span lang="EN-US">(PAPCFUNC pfnAPC, HANDLE hThread, ULONG_PTR dwData)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>NTSTATUS Status;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>Status = <b>NtQueueApcThread</b>(hThread,
IntCallUserApc,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>pfnAPC, (PVOID)dwData, NULL);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>if (Status)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;
</span>SetLastErrorByStatus(Status);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>return NT_SUCCESS(Status);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">参数</span><span lang="EN-US">pfnAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是函数指针，这就是</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数。另一个参数</span><span lang="EN-US">hThread</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是指向目标线程对象</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">已打开</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的</span><span lang="EN-US">Handle</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">，这可以是当前线程本身，也可以是同一进程中别的线程，还可以是别的进程中的某个线程。值得注意的是：如果目标线程在另一个进程中，那么</span><span lang="EN-US">pfnAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">必须是这个函数在目标线程所在用户空间的地址，而不是这个函数在本线程所在空间的地址。最后一个参数</span><span lang="EN-US">dwData</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">则是需要传递给</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数的参数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这里的</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是个系统调用。“</span><span lang="EN-US">Native API</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">”书中有关于</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的一些说明。这个系统调用把一个“用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求”挂入目标线程的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">更确切地说，是把一个带有函数指针的数据结构挂入队列</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">。注意其第二个参数是需要执行的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数指针，本该是</span><span lang="EN-US">pfnAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，这里却换成了函数</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，而</span><span lang="EN-US">pfnAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">倒变成了第三个参数，成了需要传递给</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的参数之一。</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是</span><span lang="EN-US">kernel32.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">内部的一个函数，但是并未引出，所以不能从外部直接加以调用。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US">APC</span><span style="font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">是针对具体线程、要求由具体线程加以执行的，所以每个线程都有自己的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列。内核中代表着线程的数据结构是</span><span lang="EN-US">ETHREAD</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，而</span><span lang="EN-US">ETHREAD</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中的第一个成分</span><span lang="EN-US">Tcb</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">是</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构，线程的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列就在</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">里面：</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">typedef struct
_KTHREAD</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>/* Thread state (one of
THREAD_STATE_xxx constants below) */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>UCHAR<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>State;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* 2D */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>BOOLEAN<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Alerted[2];<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* 2E */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>KAPC_STATE<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>ApcState</b>;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* 34 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>ULONG<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ContextSwitches;<span style="mso-spacerun:yes">&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;</span>/* 4C */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>ULONG<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KernelApcDisable;<span style="mso-spacerun:yes">&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;</span>/* D0 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PKQUEUE<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Queue;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* E0 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>KSPIN_LOCK<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ApcQueueLock;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/*
E4 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;
</span>PKAPC_STATE<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ApcStatePointer[2]; <span style="mso-spacerun:yes">&nbsp;&nbsp;</span><span style="mso-spacerun:yes">&nbsp;</span>/* 12C */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>KAPC_STATE<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>SavedApcState</b>;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span>/* 140 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>UCHAR<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Alertable;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="mso-spacerun:yes">&nbsp;&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;</span>/* 158 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>UCHAR<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ApcStateIndex;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span>/* 159 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>UCHAR<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ApcQueueable;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;</span>/* 15A */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>KAPC<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SuspendApc;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span>/* 160 */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">} <b>KTHREAD</b>;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US">Microsoft</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">并不公开这个数据结构的定义，所以</span><span lang="EN-US">ReactOS</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">代码中对这个数据结构的定义带有逆向工程的痕迹，每一行后面的十六进制数值就是相应结构成分在数据结构中的位移。这里我们最关心的是</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，这又是一个数据结构、即</span><span lang="EN-US">KAPC_STATE</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。可以看出，</span><span lang="EN-US">KAPC_STATE</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的大小是</span><span lang="EN-US">0x18</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">字节。其定义如下：</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">typedef struct
_KAPC_STATE {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>LIST_ENTRY<span style="mso-spacerun:yes">&nbsp; </span><b>ApcListHead</b>[2];</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PKPROCESS<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>Process;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>BOOLEAN<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>KernelApcInProgress;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>BOOLEAN<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>KernelApcPending;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>BOOLEAN<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>UserApcPending;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">} <b>KAPC_STATE</b>,
*PKAPC_STATE, *__restrict PRKAPC_STATE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">显然，这里的</span><span lang="EN-US">ApcListHead</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">就是</span><span lang="EN-US">APC</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">队列头。不过这是个大小为</span><span lang="EN-US">2</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">的数组，说明实际上</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">每个线程</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">有两个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列。这是因为</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数分为用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">和内核</span><span lang="EN-US">APC</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">两种，各有各的队列。所谓用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">，是指相应的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数位于用户空间、在用户空间执行；而内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，则相应的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数为内核函数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">读者也许已经注意到，</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">结构中除</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">外还有</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">也是</span><span lang="EN-US">KAPC_STATE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构。此外还有</span><span lang="EN-US">ApcStatePointer[2]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">和</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">两个结构成分。这是干什么用的呢？原来，在</span><span lang="EN-US">Windows</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的内核中，一个线程可以暂时“挂靠</span><span lang="EN-US">(Attach)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">”到另一个进程的地址空间。比方说，线程</span><span lang="EN-US">T</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">本来是属于进程</span><span lang="EN-US">A</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的，当这个线程在内核中运行时，如果其活动与用户空间有关</span><span lang="EN-US">(APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">就是与用户空间有关</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，那么当时的用户空间应该就是进程</span><span lang="EN-US">A</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的用户空间。但是</span><span lang="EN-US">Windows</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">内核允许一些跨进程的操作</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">例如将</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的映像装入新创进程</span><span lang="EN-US">B</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的用户空间并对其进行操作</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，所以有时候需要把当时的用户空间切换到别的进程</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">例如</span><span lang="EN-US">B) </span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的用户空间，这就称为“挂靠</span><span lang="EN-US">(Attach)</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">”，对此我将另行撰文介绍。在当前线程挂靠在另一个进程的期间，既然用户空间是别的进程的用户空间，挂在队列中的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求就变成“牛头不对马嘴”了，所以此时要把这些队列转移到别的地方，以免乱套，然后在回到原进程的用户空间时再于恢复。那么转移到什么地方呢？就是</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。当然，还要有状态信息说明本线程当前是处于“原始环境”还是“挂靠环境”，这就是</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的作用。代码中为</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的值定义了一种枚举类型：</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">typedef enum
_KAPC_ENVIRONMENT</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>OriginalApcEnvironment,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>AttachedApcEnvironment,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>CurrentApcEnvironment</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}
KAPC_ENVIRONMENT;</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">实际可用于</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的只是</span><span lang="EN-US">OriginalApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">和</span><span lang="EN-US">AttachedApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，即</span><span lang="EN-US">0</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">和</span><span lang="EN-US">1</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">。读者也许又要问，在挂靠环境下原来的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列确实不适用了，但不去用它就是，何必要把它转移呢？再说，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列转移以后，</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">不是空下来不用了吗？问题在于，在挂靠环境下也可能会有</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">针对所挂靠进程的</span><span lang="EN-US">)APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">不过当然不是来自用户空间</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">，所以需要有用于两种不同环境的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列，于是便有了</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">和</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。进一步，为了提供操作上的灵活性，又增加了一个</span><span lang="EN-US">KAPC_STATE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">指针数组</span><span lang="EN-US">ApcStatePointer[2]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，就用</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的当前值作为下标，而数组中的指针则根据情况可以分别指向两个</span><span lang="EN-US">APC_STATE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构中的一个。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这样，以</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的当前数值为下标，从指针数组</span><span lang="EN-US">ApcStatePointer[2]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中就可以得到指向</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">或</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的指针，而要求把一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求挂入队列时则可以指定是要挂入哪一个环境的队列。实际上，当</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值为</span><span lang="EN-US">OriginalApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、即</span><span lang="EN-US">0</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">时，使用的是</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">；为</span><span lang="EN-US">AttachedApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">、即</span><span lang="EN-US">1</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">时，则用的是</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">每当要求挂入一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数时，不管是用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">还是内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，内核都要为之准备好一个</span><span lang="EN-US">KAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构，并将其挂入相应的队列。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">typedef struct
_KAPC</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>CSHORT Type;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>CSHORT Size;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>ULONG Spare0;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>struct _KTHREAD* Thread;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>LIST_ENTRY ApcListEntry;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PKKERNEL_ROUTINE KernelRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PKRUNDOWN_ROUTINE RundownRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PKNORMAL_ROUTINE NormalRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PVOID NormalContext;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PVOID SystemArgument1;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PVOID SystemArgument2;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>CCHAR ApcStateIndex;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>KPROCESSOR_MODE ApcMode;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>BOOLEAN Inserted;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}<b> KAPC</b>,
*PKAPC;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">结构中的</span><span lang="EN-US">ApcListEntry</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">就是用来将</span><span lang="EN-US">KAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">结构挂入队列的。注意这个数据结构中有三个函数指针，即</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、</span><span lang="EN-US">RundownRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。其中只有</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">才指向</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">执行</span><span lang="EN-US">)APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的请求者所提供的函数，其余两个都是辅助性的。以</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">为例，其请求者</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">调用者</span><span lang="EN-US">)QueueUserAPC()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">所提供的函数是</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，所以</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">应该指向这个函数。注意真正的请求者其实是</span><span lang="EN-US">QueueUserAPC()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的调用者，真正的目标</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数也并非</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，而是前面的函数指针</span><span lang="EN-US">pfnAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">所指向的函数，而</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">起着类似于“门户”的作用。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">现在我们可以往下看系统调用</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的实现了。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">NTSTATUS </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">NtQueueApcThread</span></b><span lang="EN-US">(HANDLE ThreadHandle, PKNORMAL_ROUTINE ApcRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PVOID NormalContext, PVOID SystemArgument1, PVOID SystemArgument2)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PKAPC Apc;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PETHREAD Thread;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>KPROCESSOR_MODE PreviousMode
= ExGetPreviousMode();</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>NTSTATUS Status;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Get ETHREAD from Handle
*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Status = <b>ObReferenceObjectByHandle</b>(ThreadHandle,
THREAD_SET_CONTEXT,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>PsThreadType,
PreviousMode, (PVOID)&amp;Thread, NULL);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Allocate an APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc = <b>ExAllocatePoolWithTag(NonPagedPool</b>,
sizeof(KAPC), TAG('P', 's', 'a', 'p'));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Initialize and Queue a
user mode apc (always!) */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>KeInitializeApc</b>(Apc,
&amp;Thread-&gt;Tcb, OriginalApcEnvironment,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KiFreeApcRoutine, NULL, <b>ApcRoutine</b>, UserMode, NormalContext);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="text-indent:21.75pt;tab-stops:144.0pt"><span lang="EN-US">if (!<b>KeInsertQueueApc</b>(Apc, SystemArgument1, SystemArgument2,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>IO_NO_INCREMENT))
</span></p>

<p class="MsoNormal" style="text-indent:21.75pt;tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Status = STATUS_UNSUCCESSFUL;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>} else {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Status = STATUS_SUCCESS;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Dereference Thread and
Return */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>ObDereferenceObject(Thread);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>return Status;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">先看调用参数。第一个参数是代表着某个已打开线程的</span><span lang="EN-US">Handle</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">，这说明所要求的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数的执行者、即目标线程、可以是另一个线程，而不必是请求者线程本身。第二个参数不言自明。第三个参数</span><span lang="EN-US">NormalContext</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，以及后面的两个参数，则是准备传递给</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的参数，至于怎样解释和使用这几个参数是</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的事。看一下前面</span><span lang="EN-US">QueueUserAPC()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的代码，就可以知道这里的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数是</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，而准备传给它的参数分别为</span><span lang="EN-US">pfnAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、</span><span lang="EN-US">dwData</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、和</span><span lang="EN-US">NULL</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，前者是真正的目标</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数指针，后两者是要传给它的参数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">根据</span><span lang="EN-US">Handle</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">找到目标线程的</span><span lang="EN-US">ETHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构以后，就为</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数分配一个</span><span lang="EN-US">KAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构，并通过</span><span lang="EN-US">KeInitializeApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">加以初始化。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">[NtQueueApcThread()
&gt; KeInitializeApc()]</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">VOID</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">KeInitializeApc</span></b><span lang="EN-US">(IN PKAPC Apc,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PKTHREAD Thread,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN KAPC_ENVIRONMENT TargetEnvironment,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PKKERNEL_ROUTINE KernelRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PKRUNDOWN_ROUTINE RundownRoutine OPTIONAL,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PKNORMAL_ROUTINE NormalRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN KPROCESSOR_MODE Mode,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PVOID Context)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span>/* Set up the basic APC Structure Data */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>RtlZeroMemory(Apc,
sizeof(KAPC));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;Type = ApcObject;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;Size = sizeof(KAPC);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Set the Environment */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>if (TargetEnvironment ==
CurrentApcEnvironment) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Apc-&gt;ApcStateIndex = Thread-&gt;ApcStateIndex;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>} else {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Apc-&gt;ApcStateIndex = TargetEnvironment;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Set the Thread and
Routines */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;Thread = Thread;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;KernelRoutine =
KernelRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;RundownRoutine =
RundownRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;NormalRoutine =
NormalRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Check if this is a
Special APC, in which case we use KernelMode and no Context */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>if
(ARGUMENT_PRESENT(NormalRoutine)) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Apc-&gt;ApcMode = Mode;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Apc-&gt;NormalContext = Context;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>} else {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Apc-&gt;ApcMode = KernelMode;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这段代码本身很简单，但是有几个问题需要结合前面</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的代码再作些说明。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">首先，从</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">传下来的</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是</span><span lang="EN-US">KiFreeApcRoutine()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，顾名思义这是在为将来释放</span><span lang="EN-US">PKAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构做好准备，而</span><span lang="EN-US">RundownRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是</span><span lang="EN-US">NULL</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">其次，参数</span><span lang="EN-US">TargetEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">说明要求挂入哪一种环境下的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列。实际传下来的值是</span><span lang="EN-US">OriginalApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，表示是针对原始环境、即当前线程所属</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">而不是所挂靠</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">进程的。注意代码中所设置的是</span><span lang="EN-US">Apc-&gt;ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、即</span><span lang="EN-US">PKAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构中的</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">字段，而不是</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">结构中的</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">字段。另一方面，</span><span lang="EN-US">ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值只能是</span><span lang="EN-US">OriginalApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">或</span><span lang="EN-US">AttachedApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，如果所要求的是</span><span lang="EN-US">CurrentApcEnvironment</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">就要从</span><span lang="EN-US">Thread-&gt;ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">获取当前的环境值。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">最后，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求的模式</span><span lang="EN-US">Mode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是</span><span lang="EN-US">UserMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。但是有个例外，那就是：如果指针</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">为</span><span lang="EN-US">0</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，那么实际的模式变成了</span><span lang="EN-US">KernelMode</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。这是因为在这种情况下没有用户空间</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数可以执行，唯一将得到执行的是</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，在这里是</span><span lang="EN-US">KiFreeApcRoutine()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。这里的宏操作</span><span lang="EN-US">ARGUMENT_PRESENT</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">定义为：</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">#define
ARGUMENT_PRESENT(ArgumentPointer) \</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>((BOOLEAN) ((PVOID)ArgumentPointer !=
(PVOID)NULL))</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">回到</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">代码中，下一步就是根据</span><span lang="EN-US">Apc-&gt;ApcStateIndex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、</span><span lang="EN-US">Apc-&gt;Thread</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、和</span><span lang="EN-US">Apc-&gt;ApcMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">把准备好的</span><span lang="EN-US">KAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">结构挂入相应的队列。根据</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求的具体情况，有时候要插在队列的前头，一般则挂在队列的尾部。限于篇幅，我们在这里就不看</span><span lang="EN-US">KeInsertQueueApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的代码了；虽然这段代码中有一些特殊的处理，但都不是我们此刻所特别关心的。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">如果跟</span><span lang="EN-US">Linux</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制作一类比，那么</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">相当于设置</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">处理函数</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">或中断服务程序</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">。在</span><span lang="EN-US">Linux</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">里面，</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">处理函数的执行需要受到某种触发，例如收到了别的线程或某个内核成分发来的信号；而执行</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">处理函数的时机则是在</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">从内核返回目标线程的用户空间程序的前夕。可是</span><span lang="EN-US">Windows</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的</span><span lang="EN-US">APC</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">机制与此有所不同，一般来说，只要把</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求挂入了队列，就不再需要触发，而只是等待执行的时机。对于用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求，这时机同样也是在</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">从内核返回目标线程用户空间程序的前夕</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">对于内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">则有所不同</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。所以，在某种意义上，把一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求挂入队列，就同时意味着受到了触发。对于系统调用</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，我们可以理解为是把</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的设置与触发合在了一起。而对于异步的文件读写，则</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的设置与触发是分开的，内核先把</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数记录在别的数据结构中，等实际的文件读写完成以后才把</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求挂入队列，此时实际上只是触发其运行。不过那已是属于设备驱动框架的事了。所以，一旦把</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求挂入队列，就只是等待执行时机的问题了。从这个意义上说，“异步过程调用”还真不失为贴切的称呼。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">下面就来看执行</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的时机，那是在</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">系统调用、中断、或异常处理之后</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">从内核返回用户空间的途中。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">_KiServiceExit</span></b><span lang="EN-US">:</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Get the Current Thread */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>cli</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>movl
%fs:KPCR_CURRENT_THREAD, %esi</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Deliver APCs only if we
were called from user mode */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>testb $1, KTRAP_FRAME_CS(%esp)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>je KiRosTrapReturn</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* And only if any are
actually pending */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>cmpb $0,
KTHREAD_PENDING_USER_APC(%esi)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>je KiRosTrapReturn</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Save pointer to Trap
Frame */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>movl %esp, %ebx</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Raise IRQL to APC_LEVEL
*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>movl $1, %ecx</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>call @KfRaiseIrql@4</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Save old IRQL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>pushl %eax</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Deliver APCs */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>sti</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>pushl %ebx</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>pushl $0</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>pushl $UserMode</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>call <b>_KiDeliverApc</b>@12</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>cli</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Return to old IRQL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>popl %ecx</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span>call @KfLowerIrql@4</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这是内核中处理系统调用返回和中断</span><span lang="EN-US">/</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">异常返回的代码。在返回前夕，这里先通过</span><span lang="EN-US">%fs:KPCR_CURRENT_THREAD</span><span style="font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">取得指向当前线程的</span><span lang="EN-US">ETHREAD(</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">从而</span><span lang="EN-US">KTHREAD)</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的指针，然后依次检查：</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l7 level1 lfo10;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">即将返回的是否用户空间。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l7 level1 lfo10;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">是否有用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求正在等待执行</span><span lang="EN-US">(KTHREAD_PENDING_USER_APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是</span><span lang="EN-US">ApcState.KernelApcPending</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">在</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构中的位移</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">要是通过了这两项检查，执行针对当前线程的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求的时机就到了，于是就调用</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">去“投递”</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数，这跟</span><span lang="EN-US">Linux</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中对</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的处理又是十分相似的。注意在调用这个函数的前后还分别调用了</span><span lang="EN-US">KfRaiseIrql()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">和</span><span lang="EN-US">KfLowerIrql()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，这是为了在执行</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">期间让内核的“中断请求级别”处于</span><span lang="EN-US">APC_LEVEL</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，执行完以后再予恢复。我们现在暂时不关心“中断请求级别”，以后会回到这个问题上。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">前面讲过，</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中有两个</span><span lang="EN-US">KAPC_STATE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构，一个是</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，另一个是</span><span lang="EN-US">SavedApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，二者都有</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列，但是要投递的只是</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中的队列。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">注意在</span><span lang="EN-US">call</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">指令前面压入堆栈的三个参数，特别是首先压入堆栈的</span><span lang="EN-US">%ebx</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，它指向</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">系统空间</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">堆栈上的“中断现场”、或称“框架”，即</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">进入本次中断或系统调用时各寄存器的值，这就是下面</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的调用参数</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">下面我们看</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的代码。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">[KiDeliverApc()]</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">VOID </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">KiDeliverApc</span></b><span lang="EN-US">(KPROCESSOR_MODE DeliveryMode,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PVOID Reserved,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PKTRAP_FRAME TrapFrame)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>PKTHREAD Thread = KeGetCurrentThread();</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>ASSERT_IRQL_EQUAL(<b>APC_LEVEL</b>);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>/* Lock the APC Queue and Raise IRQL to
Synch */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span><b>KeAcquireSpinLock</b>(&amp;Thread-&gt;ApcQueueLock,
&amp;OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>/* Clear APC Pending */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>Thread-&gt;ApcState.KernelApcPending =
FALSE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>/* Do the Kernel APCs first */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>while
(!IsListEmpty(&amp;Thread-&gt;ApcState.ApcListHead[<b>KernelMode</b>])) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Get the next Entry */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>ApcListEntry =
Thread-&gt;ApcState.ApcListHead[KernelMode].Flink;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc =
CONTAINING_RECORD(ApcListEntry, KAPC, ApcListEntry);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Save Parameters so that
it's safe to free the Object in Kernel Routine*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>NormalRoutine<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>= Apc-&gt;NormalRoutine</b>;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>KernelRoutine<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>= Apc-&gt;KernelRoutine</b>;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>NormalContext<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>= Apc-&gt;NormalContext;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>SystemArgument1 =
Apc-&gt;SystemArgument1;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>SystemArgument2 =
Apc-&gt;SystemArgument2;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Special APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>if (NormalRoutine == NULL) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Remove the
APC from the list */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Apc-&gt;Inserted
= FALSE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>RemoveEntryList</b>(ApcListEntry);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Go back to
APC_LEVEL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KeReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock, OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Call the
Special APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>DPRINT("Delivering a Special APC: %x\n", Apc);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>KernelRoutine</b>(Apc,
&amp;NormalRoutine, &amp;NormalContext,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;SystemArgument1, &amp;SystemArgument2);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Raise IRQL
and Lock again */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KeAcquireSpinLock(&amp;Thread-&gt;ApcQueueLock, &amp;OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>} else {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Normal Kernel
APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if
(Thread-&gt;ApcState.KernelApcInProgress || Thread-&gt;KernelApcDisable) </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/*</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>* DeliveryMode must be KernelMode in this case, since one may not</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;</span>* return to umode while being inside a
critical section or while </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;</span>* a regular kmode apc is running (the
latter should be impossible btw).</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;</span>* -Gunnar</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;</span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ASSERT(DeliveryMode == KernelMode);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KeReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock, OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>return;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Dequeue
the APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>RemoveEntryList</b>(ApcListEntry);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Apc-&gt;Inserted = FALSE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Go back
to APC_LEVEL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KeReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock, OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Call
the Kernel APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>DPRINT("Delivering a Normal APC: %x\n", Apc);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>KernelRoutine</b>(Apc,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;NormalRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;NormalContext,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;SystemArgument1,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;SystemArgument2);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* If
There still is a Normal Routine, then we need to call this at PASSIVE_LEVEL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if
(NormalRoutine != NULL) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* At Passive Level, this APC can be prempted by a Special APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Thread-&gt;ApcState.KernelApcInProgress = TRUE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><b>KeLowerIrql</b>(PASSIVE_LEVEL);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* Call and Raise IRQ back to APC_LEVEL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;</span>DPRINT("Calling
the Normal Routine for a Normal APC: %x\n", Apc);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;</span><b>NormalRoutine</b>(&amp;NormalContext,
&amp;SystemArgument1, &amp;SystemArgument2);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;</span><b>KeRaiseIrql</b>(APC_LEVEL,
&amp;OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Raise IRQL
and Lock again */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>KeAcquireSpinLock(&amp;Thread-&gt;ApcQueueLock, &amp;OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Thread-&gt;ApcState.KernelApcInProgress = FALSE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>}<span style="mso-spacerun:yes">&nbsp;
</span>//end while</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">参数</span><span lang="EN-US">DeliveryMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">表示需要“投递”哪一种</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，可以是</span><span lang="EN-US">UserMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，也可以是</span><span lang="EN-US">KernelMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。不过，</span><span lang="EN-US">KernelMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">确实表示只要求执行内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，而</span><span lang="EN-US">UserMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">却表示在执行内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">之外再执行用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。这里所谓“执行内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">”是执行内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中的所有请求，而“执行用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">”却只是执行用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中的一项。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">所以首先检查内核模式</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列，只要非空就通过一个</span><span lang="EN-US">while</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">循环处理其所有的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求。队列中的每一项</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">如果队列非空的话</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、即每一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求都是</span><span lang="EN-US">KAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">结构，结构中有三个函数指针，但是这里只涉及其中的两个。一个是</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，若为非</span><span lang="EN-US">0</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">就是指向一个实质性的内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数。另一个是</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，指向一个辅助性的内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数，这个指针不会是</span><span lang="EN-US">0</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，否则这个</span><span lang="EN-US">KAPC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">结构就不会在队列中了</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">注意</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">与内核模式</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的区别</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">为</span><span lang="EN-US">0</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">是一种特殊的情况，在这种情况下</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">所指的内核函数无条件地得到调用。但是，如果</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">非</span><span lang="EN-US">0</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">，那么首先得到调用的是</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，而指针</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的地址是作为参数传下去的。</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的执行有可能改变这个指针的值。这样，如果执行</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">以后</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">仍为非</span><span lang="EN-US">0</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，那就说明需要加以执行，所以通过这个函数指针予以调用。不过，内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的执行是在</span><span lang="EN-US">PASSIVE_LEVEL</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">级别上执行的，所以对</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的调用前有</span><span lang="EN-US">KeLowerIrql()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">、后有</span><span lang="EN-US">KeRaiseIrql()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，前者将</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的运行级别调整为</span><span lang="EN-US">PASSIVE_LEVEL</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，后者则将其恢复为</span><span lang="EN-US">APC_LEVEL</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">执行完内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中的所有请求以后，如果调用参数</span><span lang="EN-US">DeliveryMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">为</span><span lang="EN-US">UserMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的话，就轮到用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">了。我们继续往下看：</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">[KiDeliverApc()]</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>/* Now we do the User APCs */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>if
((!IsListEmpty(&amp;Thread-&gt;ApcState.ApcListHead[UserMode])) &amp;&amp;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(DeliveryMode ==
UserMode) &amp;&amp; (Thread-&gt;ApcState.UserApcPending == TRUE)) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* It's not pending anymore
*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Thread-&gt;ApcState.UserApcPending
= FALSE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Get the APC Object */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>ApcListEntry =
Thread-&gt;ApcState.ApcListHead[UserMode].Flink;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc =
CONTAINING_RECORD(ApcListEntry, KAPC, ApcListEntry);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Save Parameters so that
it's safe to free the Object in Kernel Routine*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>NormalRoutine<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>= Apc-&gt;NormalRoutine</b>;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>KernelRoutine<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>= Apc-&gt;KernelRoutine</b>;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>NormalContext<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>= Apc-&gt;NormalContext;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>SystemArgument1 =
Apc-&gt;SystemArgument1;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>SystemArgument2 =
Apc-&gt;SystemArgument2; </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Remove the APC from
Queue, restore IRQL and call the APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>RemoveEntryList</b>(ApcListEntry);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Apc-&gt;Inserted = FALSE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;
</span>KeReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock, OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>DPRINT("Calling the
Kernel Routine for for a User APC: %x\n", Apc);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>KernelRoutine</b>(Apc,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;NormalRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;NormalContext,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;SystemArgument1,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;SystemArgument2);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>if (NormalRoutine == NULL) {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Check if more
User APCs are Pending */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>KeTestAlertThread</b>(UserMode);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}else {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/* Set up the
Trap Frame and prepare for Execution in NTDLL.DLL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>DPRINT("Delivering a User APC: %x\n", Apc);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>KiInitializeUserApc</b>(Reserved,
</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>TrapFrame,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>NormalRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>NormalContext,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SystemArgument1,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>SystemArgument2);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>} else {</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Go back to APC_LEVEL */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;
</span>KeReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock, OldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">当然，执行用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是有条件的。首先自然是用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列非空，同时调用参数</span><span lang="EN-US">DeliveryMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">必须是</span><span lang="EN-US">UserMode</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">；并且</span><span lang="EN-US">ApcState</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中的</span><span lang="EN-US">UserApcPending</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">为</span><span lang="EN-US">TRUE</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，表示队列中的请求确实是要求尽快加以执行的。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">读者也许已经注意到，比之内核</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列，对用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列的处理有个显著的不同，那就是对用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列并不是通过一个</span><span lang="EN-US">while</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">循环处理队列中的所有请求，而是每次进入</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">只处理用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中的第一个请求。同样，这里也是只涉及两个函数指针，即</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">和</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，也是先执行</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，并且</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">可以对指针</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">作出修正。但是再往下就不同了。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">首先，如果执行完</span><span lang="EN-US">KernelRoutine(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">所指的函数</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">以后指针</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">为</span><span lang="EN-US">0</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">，这里要执行</span><span lang="EN-US">KeTestAlertThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。这又是跟设备驱动有关的事</span><span lang="EN-US">(Windows</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">术语中的</span><span lang="EN-US">Alert</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">相当于</span><span lang="EN-US">Linux</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">术语中的“唤醒”</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，我们在这里暂不关心。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">反之，如果指针</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">仍为非</span><span lang="EN-US">0</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，那么这里执行的是</span><span lang="EN-US">KiInitializeUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，而不是直接调用</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">所指的函数，因为</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">所指的函数是在用户空间，要等</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">回到用户空间才能执行，这里只是为其作好安排和准备。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">[KiDeliverApc()
&gt; KiInitializeUserApc()]</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">VOID</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">KiInitializeUserApc</span></b><span lang="EN-US">(IN PVOID Reserved,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PKTRAP_FRAME TrapFrame,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PKNORMAL_ROUTINE NormalRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PVOID NormalContext,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PVOID SystemArgument1,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN PVOID SystemArgument2)<span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PCONTEXT Context;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PULONG Esp;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/*</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>* Save the thread's current
context (in other words the registers</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>* that will be
restored when it returns to user mode) so the</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>* APC dispatcher can
restore them later</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>Context</b> =
(PCONTEXT)(((PUCHAR)TrapFrame-&gt;Esp) - sizeof(CONTEXT));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>RtlZeroMemory(Context,
sizeof(CONTEXT));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;ContextFlags =
CONTEXT_FULL;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;SegGs =
TrapFrame-&gt;Gs;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;SegFs =
TrapFrame-&gt;Fs;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;SegEs =
TrapFrame-&gt;Es;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;SegDs =
TrapFrame-&gt;Ds;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Edi =
TrapFrame-&gt;Edi;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Esi =
TrapFrame-&gt;Esi;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Ebx =
TrapFrame-&gt;Ebx;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Edx =
TrapFrame-&gt;Edx;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Ecx =
TrapFrame-&gt;Ecx;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Eax =
TrapFrame-&gt;Eax;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Ebp =
TrapFrame-&gt;Ebp;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Eip =
TrapFrame-&gt;Eip;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;SegCs = TrapFrame-&gt;Cs;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;EFlags =
TrapFrame-&gt;Eflags;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;Esp =
TrapFrame-&gt;Esp;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Context-&gt;SegSs =
TrapFrame-&gt;Ss;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/*</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>* Setup the trap frame
so the thread will start executing at the</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>* APC Dispatcher when
it returns to user-mode</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp =
(PULONG)(((PUCHAR)TrapFrame-&gt;Esp) - </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>(sizeof(CONTEXT) + (6 * sizeof(ULONG))));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp[0] = 0xdeadbeef;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp[1] =
(ULONG)NormalRoutine;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp[2] =
(ULONG)NormalContext;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp[3] =
(ULONG)SystemArgument1;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp[4] =
(ULONG)SystemArgument2;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Esp[5] = (ULONG)<b>Context</b>;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>TrapFrame-&gt;Eip = (ULONG)<b>LdrpGetSystemDllApcDispatcher</b>();</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>TrapFrame-&gt;Esp =
(ULONG)Esp;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这个函数的名字取得不好，很容易让人把它跟前面的</span><span lang="EN-US">KeInitializeApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">相连系，实际上却完全是两码事。参数</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">是由</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">传下来的一个指针，指向用户空间堆栈上的“中断现场”。这里要做的事情就是在原有现场的基础上“注水”，伪造出一个新的现场，使得</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">返回用户空间时误认为中断</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">或系统调用</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">发生于进入</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的前夕，从而转向</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">怎么伪造呢？首先使用户空间的堆栈指针</span><span lang="EN-US">Esp</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">下移一个</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构的大小，外加</span><span lang="EN-US">6</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">位整数的位置</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">注意堆栈是由上向下伸展的</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。换言之就是在用户空间堆栈上扩充出一个</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构和</span><span lang="EN-US">6</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">位整数。注意，</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是在系统空间堆栈上，而</span><span lang="EN-US">TrapFrame-&gt;Esp</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值是用户空间的堆栈指针，所指向的是用户空间堆栈。所以这里扩充的是用户空间堆栈。这样，原先的用户堆栈下方是</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">数据结构</span><span lang="EN-US">Context</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，再往下就是那</span><span lang="EN-US">6</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">位整数。然后把</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的内容保存在这个</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构中，并设置好</span><span lang="EN-US">6</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">位整数，那是要作为调用参数传递的。接着就把保存在</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中的</span><span lang="EN-US">Eip</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">映像改成指向用户空间的一个特殊函数，具体的地址通过</span><span lang="EN-US">LdrpGetSystemDllApcDispatcher()</span><span style="font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">获取。这样，当</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">返回到用户空间时，就会从这个特殊函数“继续”执行。当然，也要调整</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中的用户空间堆栈指针</span><span lang="EN-US">Esp</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US">LdrpGetSystemDllApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">只是返回一个</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">内核</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">全局量</span><span lang="EN-US">SystemDllApcDispatcher</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的值，这个值是个函数指针，指向</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中的一个函数，是在映射</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">映像时设置好的。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">PVOID
LdrpGetSystemDllApcDispatcher(VOID)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>return(<b>SystemDllApcDispatcher</b>);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">与全局变量</span><span lang="EN-US">SystemDllApcDispatcher</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">相似的函数指针有：</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo8;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">SystemDllEntryPoint</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，指向</span><span lang="EN-US">LdrInitializeThunk()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo8;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">SystemDllApcDispatcher</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，指向</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo8;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">SystemDllExceptionDispatcher</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，指向</span><span lang="EN-US">KiUserExceptionDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo8;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">SystemDllCallbackDispatcher</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，指向</span><span lang="EN-US">KiUserCallbackDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l8 level1 lfo8;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">SystemDllRaiseExceptionDispatcher</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，指向</span><span lang="EN-US">KiRaiseUserExceptionDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这些指针都是在</span><span lang="EN-US">LdrpMapSystemDll()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中得到设置的。给定一个函数名的字符串，就可以通过一个函数</span><span lang="EN-US">LdrGetProcedureAddress()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">从</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">已经映射的</span><span lang="EN-US">)DLL</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">映像中获取这个函数的地址</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">如果这个函数被引出的话</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">于是，</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">从</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">回到</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">以后会继续完成其返回用户空间的行程，只是一到用户空间就栽进了圈套，那就是</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，而不是回到原先的断点上。关于原先断点的现场信息保存在用户空间堆栈上、并形成一个</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">数据结构，但是“深埋”在</span><span lang="EN-US">6</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">位整数的后面。而这</span><span lang="EN-US">6</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">位整数的作用则为：</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l0 level1 lfo11;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">Esp[0]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值为</span><span lang="EN-US">0xdeadbeef</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，用来模拟</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的返回地址。当然，这个地址是无效的，所以</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">实际上是不会返回的。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l0 level1 lfo11;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">Esp[1]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值为</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，在我们这个情景中指向“门户”函数</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l0 level1 lfo11;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">Esp[2]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值为</span><span lang="EN-US">NormalContext</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，在我们这个情景中是指向实际</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数的指针。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l0 level1 lfo11;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="font-family:Wingdings;mso-fareast-font-family:Wingdings;mso-bidi-font-family:
Wingdings"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">余类推。其中</span><span lang="EN-US">Esp[5]</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">指向</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">用户</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">堆栈上的</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">数据结构。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">总之，用户堆栈上的这</span><span lang="EN-US">6</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">个</span><span lang="EN-US">32</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">位整数模拟了一次</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">在进入</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">还没有来得及执行其第一条指令之前就发生了中断的假象，使得</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">在结束了</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的执行、回到</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中继续前行、并最终回到用户空间时就进入</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">执行其第一条指令。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">另一方面，对于该线程原来的上下文而言，则又好像是刚回到用户空间就发生了中断，而</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">则相当于中断相应程序。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">VOID STDCALL </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">KiUserApcDispatcher</span></b><span lang="EN-US">(PIO_APC_ROUTINE ApcRoutine, PVOID ApcContext,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PIO_STATUS_BLOCK Iosb, ULONG Reserved, PCONTEXT Context)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>/* Call the APC */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><b>ApcRoutine</b>(ApcContext,
Iosb, Reserved);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>/* Switch back to the interrupted
context */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><b>NtContinue</b>(Context, 1);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这里的第一个参数</span><span lang="EN-US">ApcRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">指向</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，第二个参数</span><span lang="EN-US">ApcContext</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">指向真正的</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">目标</span><span lang="EN-US">)APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">[KiUserApcDispatcher()
&gt; IntCallUserApc()]</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">static void
CALLBACK</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">IntCallUserApc</span></b><span lang="EN-US">(PVOID Function, PVOID dwData, PVOID Argument3)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>PAPCFUNC pfnAPC =
(PAPCFUNC)Function;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>pfnAPC((ULONG_PTR)dwData);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">可见，</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">其实并无必要，在</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中直接调用目标</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数也无不可，这样做只是为将来可能的修改扩充提供一些方便和灵活性。从</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">回到</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，下面紧接着是系统调用</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是不返回的。它之所以不返回，是因为对</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的调用不返回。正如代码中的注释所述，</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的作用是切换回被中断了的上下文，不过其实还不止于此，下面读者就会看到它还起着循环执行整个用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求队列的作用。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">[KiUserApcDispatcher()
&gt; NtContinue()]</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">NTSTATUS STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">NtContinue</span></b><span lang="EN-US"> (IN PCONTEXT Context, <span style="mso-spacerun:yes">&nbsp;</span>IN
BOOLEAN TestAlert)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PKTHREAD Thread = <b>KeGetCurrentThread</b>();</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PKTRAP_FRAME TrapFrame =
Thread-&gt;TrapFrame;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PKTRAP_FRAME PrevTrapFrame =
(PKTRAP_FRAME)TrapFrame-&gt;Edx;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PFX_SAVE_AREA FxSaveArea;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>KIRQL oldIrql;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>DPRINT("NtContinue:
Context: Eip=0x%x, Esp=0x%x\n", Context-&gt;Eip, Context-&gt;Esp );</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>PULONG Frame = 0;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>__asm__("mov %%ebp,
%%ebx" : "=b" (Frame) : );</span></p>

<p class="MsoNormal" style="tab-stops:102.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/*</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>* Copy the supplied context
over the register information that was saved</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>* on entry to kernel mode,
it will then be restored on exit</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>* FIXME: Validate the
context</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><b>KeContextToTrapFrame</b>
( Context, TrapFrame );</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Put the floating point
context into the thread's FX_SAVE_AREA</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>* and make sure it is
reloaded when needed.</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>FxSaveArea =
(PFX_SAVE_AREA)((ULONG_PTR)Thread-&gt;InitialStack C </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>sizeof(FX_SAVE_AREA));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>if
(KiContextToFxSaveArea(FxSaveArea, Context))</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span>Thread-&gt;NpxState =
NPX_STATE_VALID;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>KeRaiseIrql</b>(DISPATCH_LEVEL,
&amp;oldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if
(KeGetCurrentPrcb()-&gt;NpxThread == Thread)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><b>KeGetCurrentPrcb</b>()-&gt;NpxThread = NULL;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><b>Ke386SetCr0(Ke386GetCr0</b>() | X86_CR0_TS);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>else</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ASSERT((Ke386GetCr0() &amp; X86_CR0_TS) == X86_CR0_TS);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>KeLowerIrql</b>(oldIrql);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>/* Restore the user context
*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Thread-&gt;TrapFrame =
PrevTrapFrame;</span></p>

<p class="MsoNormal" style="text-indent:21.75pt;tab-stops:144.0pt"><span lang="EN-US">__asm__("mov %%ebx, %%esp;\n" "<b>jmp _KiServiceExit</b>":
: "b" (TrapFrame));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>return STATUS_SUCCESS; /*
this doesn't actually happen */</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">注意从</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">到</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">并不是普通的函数调用，而是系统调用，这中间经历了空间的切换，也从用户空间堆栈切换到了系统空间堆栈。</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">进入系统调用空间后，在</span><span lang="EN-US">_KiSystemServicex</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">下面的代码中把指向中断现场的框架指针保存在当前线程的</span><span lang="EN-US">KTHREAD</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">数据结构的</span><span lang="EN-US">TrapFrame</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">字段中。这样，很容易就可以找到系统空间堆栈上的调用框架。当然，现在的框架是因为系统调用而产生的框架；而要想回到当初、即在执行用户空间</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数之前的断点，就得先恢复当初的框架。那么当初的框架在哪里呢？它保存在用户空间的堆栈上，就是前面</span><span lang="EN-US">KiInitializeUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">保存的</span><span lang="EN-US">CONTEXT</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">数据结构中。所以，这里通过</span><span lang="EN-US">KeContextToTrapFrame()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">把当初保存的信息拷贝回来，从而恢复了当初的框架。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">下面的</span><span lang="EN-US">KiContextToFxSaveArea()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">等语句与浮点处理器有关，我们在这里并不关心。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">最后，汇编指令“</span><span lang="EN-US">jmp
_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">”使</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">跳转到了返回用户空间途中的</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">处</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">见前面的代码</span><span lang="EN-US">)</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">。在这里，</span><span lang="EN-US">CPU</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">又会检查</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求队列中是否有</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求等着要执行，如果有的话又会进入</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。前面讲过，每次进入</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">只会执行一个用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求，所以如果用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列的长度大于</span><span lang="EN-US">1</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的话就得循环着多次走过上述的路线，即：</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">从系统调用、中断、或异常返回途径</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，如果</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列中有等待执行的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求，就调用</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，从用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中摘下一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">3.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">在</span><span lang="EN-US">KiInitializeUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中保存当前框架，并伪造新的框架。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">4.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">回到用户空间。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">5.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">在</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中调用目标</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">6.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">通过系统调用</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">进入系统空间。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">7.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">在</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中恢复当初保存的框架。</span></p>

<p class="MsoNormal" style="margin-left:42.0pt;text-indent:-21.0pt;mso-list:l11 level1 lfo13;
tab-stops:list 42.0pt left 144.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:&quot;Times New Roman&quot;"><span style="mso-list:Ignore">8.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">从</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">返回、途径</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">时，如果</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列中还有等待执行的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求，就调用</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。于是转回上面的第二步。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">这个过程一直要循环到</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中不再有需要执行的请求。注意这里每一次循环中保存和恢复的都是同一个框架，就是原始的、开始处理</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列之前的那个框架，代表着原始的用户空间程序断点。一旦</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">队列中不再有等待执行的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求，在</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">下面就不再调用</span><span lang="EN-US">KiDeliverApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，于是就直接返回用户空间，这次是返回到原始的程序断点了。所以，系统调用</span><span lang="EN-US">neContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的作用不仅仅是切换回到被中断了的上下文，还包括执行用户</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中的下一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">对于</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">而言，它对</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的调用是不返回的。因为在</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中</span><span lang="EN-US">CPU</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">不是“返回”到对于</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的另一次调用、从而对另一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的调用；就是返回到原始的用户空间程序断点，这个断点既可能是因为中断或异常而形成的，也可能是因为系统调用而形成的。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">理解了常规的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求和执行机制，我们不妨再看看启动执行</span><span lang="EN-US">PE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">目标映像时函数的动态连接。以前讲过，</span><span lang="EN-US">PE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">格式</span><span lang="EN-US">EXE</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">映像与</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">除</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">外的</span><span lang="EN-US">)DLL</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的动态连接、包括这些</span><span lang="EN-US">DLL</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">的装入，是由</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">中的一个函数</span><span class="docemphasis"><span lang="EN-US">LdrInitializeThunk()</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">作为</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数执行而完成的，所以这也是对</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">机制的一种变通使用。</span><span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span class="docemphasis"><span style="font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">要启动一个</span></span><span lang="EN-US">EXE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">映像运行时，首先要创建进程，再把目标</span><span lang="EN-US">EXE</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">映像和</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的映像都映射到新进程的用户空间，然后通过系统调用</span><span lang="EN-US">NtCreateThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">创建这个进程的第一个线程、或称“主线程”。而</span><span class="docemphasis"><span lang="EN-US">LdrInitializeThunk()</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">作为</span><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数的执行，就是在</span></span><span lang="EN-US">NtCreateThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">中安排好的。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">NtCreateThread</span></b><span lang="EN-US">(OUT PHANDLE ThreadHandle, IN ACCESS_MASK DesiredAccess,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>IN POBJECT_ATTRIBUTES ObjectAttributes<span style="mso-spacerun:yes">&nbsp; </span>OPTIONAL,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>IN
HANDLE ProcessHandle, OUT PCLIENT_ID ClientId,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>IN
PCONTEXT ThreadContext, IN PINITIAL_TEB InitialTeb,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>IN
BOOLEAN CreateSuspended)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>HANDLE hThread;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>/*</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>* Queue an APC to the thread that
will execute the ntdll startup</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>* routine.</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>LdrInitApc =
ExAllocatePool(NonPagedPool, sizeof(KAPC));</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span><b>KeInitializeApc</b>(LdrInitApc,
&amp;Thread-&gt;Tcb, OriginalApcEnvironment, </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><b>LdrInitApcKernelRoutine</b>, </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><b>LdrInitApcRundownRoutine</b>,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><b>LdrpGetSystemDllEntryPoint</b>(), UserMode, NULL);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span><b>KeInsertQueueApc</b>(LdrInitApc,
NULL, NULL, IO_NO_INCREMENT);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>/* </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>* The thread is non-alertable, so
the APC we added did not set UserApcPending to TRUE. </span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>* We must do this manually. Do NOT
attempt to set the Thread to Alertable before the call,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>* doing so is a blatant and
erronous hack.</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>*/</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>Thread-&gt;Tcb.ApcState.UserApcPending =
TRUE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>Thread-&gt;Tcb.Alerted[KernelMode] =
TRUE;</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>. . . . . .</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span lang="EN-US">NeCreateThread()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">要做的事当然很多，但是其中很重要的一项就是安排好</span><span class="docemphasis"><span lang="EN-US">APC</span></span><span class="docemphasis"><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">函数的执行。这里的</span></span><span lang="EN-US">KeInitializeApc()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">和</span><span lang="EN-US">KeInsertQueueApc</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">读者都已经熟悉了，所以我们只关心调用参数中的三个函数指针，特别是其中的</span><span lang="EN-US">KernelRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">和</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。前者十分简单：</span><span class="docemphasis"><span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">VOID STDCALL</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><b><span lang="EN-US">LdrInitApcKernelRoutine</span></b><span lang="EN-US">(PKAPC Apc, PKNORMAL_ROUTINE* NormalRoutine,</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PVOID* NormalContext, PVOID* SystemArgument1, PVOID* SystemArgument2)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp; </span>ExFreePool(Apc);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">而</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，这里是通过</span><span lang="EN-US">LdrpGetSystemDllEntryPoint()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">获取的，它只是返回全局量</span><span lang="EN-US">SystemDllEntryPoint</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的值：</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">PVOID <b>LdrpGetSystemDllEntryPoint</b>(VOID)</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">{</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><span style="mso-spacerun:yes">&nbsp;&nbsp; </span>return(SystemDllEntryPoint);</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US">}</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">前面已经讲到，全局量</span><span lang="EN-US">SystemDllEntryPoint</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">是在</span><span lang="EN-US">LdrpMapSystemDll()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">时得到设置的，指向已经映射到用户空间的</span><span lang="EN-US">ntdll.dll</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">映像中的</span><span lang="EN-US">LdrInitializeThunk()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。注意这</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">请求是挂在新线程的队列中，而不是当前进程的队列中。事实上，新线程和当前进程处于不同的进程，因而不在同一个用户空间中。还要注意，这里的</span><span lang="EN-US">NormalRoutine</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">直接就是</span><span lang="EN-US">LdrInitializeThunk()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">，而不像前面通过</span><span lang="EN-US">QueueUserAPC()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">发出的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求那样中间还有一层</span><span lang="EN-US">IntCallUserApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。至于</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">，那是由</span><span lang="EN-US">KeInitializeApc()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">强制加上的，正是这个函数保证了对</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的调用。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0;
tab-stops:144.0pt"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">此后的流程本来无需细说了，但是由于情景的特殊性还是需要加一些简要的说明。由</span><span lang="EN-US">NtCreateProcess()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">创建的进程并非一个可以调度运行的实体，而</span><span lang="EN-US">NtCreateThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">创建的线程却是。所以，在</span><span lang="EN-US">NtCreateProcess()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">返回的前夕，系统中已经多了一个线程。这个新增线程的“框架”是伪造的，目的在于让这个线程一开始在用户空间运行就进入预定的程序入口。从</span><span lang="EN-US">NtCreateProcess()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">返回是回到当前线程、而不是新增线程，而刚才的</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求是挂在新增线程的队列中，所以在从</span><span lang="EN-US">NtCreateThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">返回的途中不会去执行这个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求。可是，当新增线程受调度运行时，首先就是按伪造的框架和堆栈模拟一个从系统调用返回的过程，所以也要途径</span><span lang="EN-US">_KiServiceExit</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">。这时候，这个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">请求就要得到执行了</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">由</span><span lang="EN-US">KiUserApcDispatcher()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">调用</span><span lang="EN-US">LdrInitializeThunk())</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">。然后，在用户空间执行完</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数</span><span lang="EN-US">LdrInitializeThunk()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">以后，同样也是通过</span><span lang="EN-US">NtContinue()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">回到内核中，然后又按原先的伪造框架“返回”到用户空间，这才真正开始了新线程在用户空间的执行。</span></p>

<p class="MsoNormal" style="tab-stops:144.0pt"><span lang="EN-US"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">最后，我们不妨比较一下</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制和</span><span lang="EN-US">Unix/Linux</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span lang="EN-US">Unix/Linux</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">的</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">机制基本上是对硬件中断机制的软件模拟，具体表现在以下几个方面：</span></p>

<p class="MsoNormal" style="margin-left:57.0pt;text-indent:-36.0pt;mso-list:l9 level1 lfo9;
tab-stops:list 57.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:
&quot;Times New Roman&quot;"><span style="mso-list:Ignore">1）<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">现代的硬件中断机制一般都是“向量中断”机制，而</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">机制中的</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">序号</span><span lang="EN-US">(</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">例如</span><span lang="EN-US">SIG_KILL)</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">就是对中断向量序号的模拟。</span></p>

<p class="MsoNormal" style="margin-left:57.0pt;text-indent:-36.0pt;mso-list:l9 level1 lfo9;
tab-stops:list 57.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:
&quot;Times New Roman&quot;"><span style="mso-list:Ignore">2）<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">作为操作系统对硬件中断机制的支持，一般都会提供“设置中断向量”一类的内核函数，使特定序号的中断向量指向某个中断服务程序。而系统调用</span><span lang="EN-US">signal()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">就相当于是这一类的函数。只不过前者在内核中、一般只是供其它内核函数调用，而后者是系统调用、供用户空间的程序调用。</span></p>

<p class="MsoNormal" style="margin-left:57.0pt;text-indent:-36.0pt;mso-list:l9 level1 lfo9;
tab-stops:list 57.0pt"><!--[if !supportLists]--><span lang="EN-US" style="mso-fareast-font-family:
&quot;Times New Roman&quot;"><span style="mso-list:Ignore">3）<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">在硬件中断机制中，“中断向量”的设置只是为某类异步事件、及中断的发生做好了准备，但是并不意味着某个特定时间的发生。如果一直没有中断请求，那么所设置的中断向量就一直得不到执行，而中断的发生只是触发了中断服务程序的执行。在</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">机制中，向某个进程发出“信号”、即</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">、就相当于中断请求。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt"><span style="font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">相比之下，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">机制就不能说是对于硬件中断机制的模拟了。首先，通过</span><span lang="EN-US">NtQueueApcThread()</span><span style="font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">设置一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数跟通过</span><span lang="EN-US">signal()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">设置一个“中断向量”有所不同。将一个</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">函数挂入</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列中时，对于这个函数的得到执行、以及大约在什么时候得到执行，实际上是预知的，只是这得到执行的条件要过一回儿才会成熟。而“中断”则不同，中断向量的设置只是说如果发生某种中断则如何如何，但是对于其究竟是否会发生、何时发生则常常是无法预测的。所以，从这个意义上说，</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数只是一种推迟执行、异步执行的函数调用，因此称之为“异步过程调用”确实更为贴切。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">还有，</span><span lang="EN-US">signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制的</span><span lang="EN-US">signal()</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">所设置的“中断服务程序”都是用户空间的程序，而</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">机制中挂入</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">队列的函数却可以是内核函数。</span></p>

<p class="MsoNormal" style="text-indent:21.0pt;mso-char-indent-count:2.0"><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">但是，尽管如此，它们的</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">某些方面的</span><span lang="EN-US">)</span><span style="font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;">实质还是一样的。“中断”本来就是一种异步执行的机制。再说，</span><span lang="EN-US">(</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">用户</span><span lang="EN-US">)APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">与</span><span lang="EN-US">Signal</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;">的执行流程几乎完全一样，都是在从内核返回用户空间的前夕检查是否有这样的函数需要加以执行，如果是就临时修改堆栈，偏离原来的执行路线，使得返回用户空间后进入</span><span lang="EN-US">APC</span><span style="font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;">函数，并且在执行完了这个函数以后仍进入内核，然后恢复原来的堆栈，再次返回用户空间原来的断点。这样，对于原来的流程而言，就相当于受到了中断。</span></p>

</div>




<!--
     FILE ARCHIVED ON 22:12:10 May 04, 2018 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 12:45:07 Apr 13, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 137.826
  exclusion.robots: 0.206
  exclusion.robots.policy: 0.2
  RedisCDXSource: 7.915
  esindex: 0.007
  LoadShardBlock: 111.516 (3)
  PetaboxLoader3.datanode: 161.996 (4)
  CDXLines.iter: 15.725 (3)
  load_resource: 172.735
  PetaboxLoader3.resolve: 30.362
--><div id="react-toast" class="Toaster"><span class="Toaster__manager-top-left" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; top: 0px; left: 0px;"></span><span class="Toaster__manager-top" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; margin: 0px auto; text-align: center; top: 0px; right: 0px; left: 0px;"></span><span class="Toaster__manager-top-right" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; top: 0px; right: 0px;"></span><span class="Toaster__manager-bottom-left" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; bottom: 0px; left: 0px;"></span><span class="Toaster__manager-bottom" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; margin: 0px auto; text-align: center; bottom: 0px; right: 0px; left: 0px;"></span><span class="Toaster__manager-bottom-right" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; bottom: 0px; right: 0px;"></span></div><script src="chrome-extension://gppongmhjkpfnbhagpmjfkannfbllamg/js/js.js"></script><script src="chrome-extension://gppongmhjkpfnbhagpmjfkannfbllamg/js/js.js"></script><script src="chrome-extension://gppongmhjkpfnbhagpmjfkannfbllamg/js/js.js"></script></body><div style="all: initial;"><div id="__hcfy__" style="all: initial;"></div></div></html>