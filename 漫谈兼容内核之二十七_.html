
<!-- saved from url=(0098)https://web.archive.org/web/20171109105730/http://www.longene.org/techdoc/0409875001314757116.html -->
<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="Content-Type" content="text/html; charset=gb18030"><script src="./关于SMP_files/analytics.js.下载" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app223.us.archive.org';v.server_ms=161;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="./关于SMP_files/bundle-playback.js.下载" charset="utf-8"></script>
<script type="text/javascript" src="./关于SMP_files/wombat.js.下载" charset="utf-8"></script>
<script type="text/javascript">
  __wm.init("https://web.archive.org/web");
  __wm.wombat("http://www.longene.org:80/techdoc/0409875001314757116.html","20171109105730","https://web.archive.org/","web","/_static/",
	      "1510225050");
</script>
<link rel="stylesheet" type="text/css" href="./关于SMP_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="./关于SMP_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->


<meta name="ProgId" content="Word.Document">
<meta name="Generator" content="Microsoft Word 11">
<meta name="Originator" content="Microsoft Word 11">
<link rel="File-List" href="https://web.archive.org/web/20171109105730/http://www.longene.org/techdoc/0409875001314757116.files/filelist.xml">
<link rel="Edit-Time-Data" href="https://web.archive.org/web/20171109105730/http://www.longene.org/techdoc/0409875001314757116.files/editdata.mso">
<!--[if !mso]>
<style>
v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
.shape {behavior:url(#default#VML);}
</style>
<![endif]-->
<title>关于SMP</title>
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:PunctuationKerning/>
  <w:DrawingGridHorizontalSpacing>6 磅</w:DrawingGridHorizontalSpacing>
  <w:DrawingGridVerticalSpacing>6 磅</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>3</w:DisplayVerticalDrawingGridEvery>
  <w:UseMarginsForDrawingGridOrigin/>
  <w:ValidateAgainstSchemas>false</w:ValidateAgainstSchemas>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:DoNotUnderlineInvalidXML/>
  <w:DoNotShadeFormData/>
  <w:Compatibility>
   <w:SpaceForUL/>
   <w:BalanceSingleByteDoubleByteWidth/>
   <w:DoNotLeaveBackslashAlone/>
   <w:ULTrailSpace/>
   <w:DoNotExpandShiftReturn/>
   <w:FootnoteLayoutLikeWW8/>
   <w:ShapeLayoutLikeWW8/>
   <w:AlignTablesRowByRow/>
   <w:ForgetLastTabAlignment/>
   <w:AdjustLineHeightInTable/>
   <w:LayoutRawTableWidth/>
   <w:LayoutTableRowsApart/>
   <w:UseWord97LineBreakingRules/>
   <w:SelectEntireFieldWithStartOrEnd/>
   <w:UseWord2002TableStyleRules/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
  <w:LsdException Locked="true" Name="Normal"/>
  <w:LsdException Locked="true" Name="heading 1"/>
  <w:LsdException Locked="true" Name="heading 2"/>
  <w:LsdException Locked="true" Name="heading 3"/>
  <w:LsdException Locked="true" Name="heading 4"/>
  <w:LsdException Locked="true" Name="heading 5"/>
  <w:LsdException Locked="true" Name="heading 6"/>
  <w:LsdException Locked="true" Name="heading 7"/>
  <w:LsdException Locked="true" Name="heading 8"/>
  <w:LsdException Locked="true" Name="heading 9"/>
  <w:LsdException Locked="true" Name="toc 1"/>
  <w:LsdException Locked="true" Name="toc 2"/>
  <w:LsdException Locked="true" Name="toc 3"/>
  <w:LsdException Locked="true" Name="toc 4"/>
  <w:LsdException Locked="true" Name="toc 5"/>
  <w:LsdException Locked="true" Name="toc 6"/>
  <w:LsdException Locked="true" Name="toc 7"/>
  <w:LsdException Locked="true" Name="toc 8"/>
  <w:LsdException Locked="true" Name="toc 9"/>
  <w:LsdException Locked="true" Name="caption"/>
  <w:LsdException Locked="true" Name="Title"/>
  <w:LsdException Locked="true" Name="Subtitle"/>
  <w:LsdException Locked="true" Name="Strong"/>
  <w:LsdException Locked="true" Name="Emphasis"/>
  <w:LsdException Locked="true" Name="Table Grid"/>
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-1610611985 1073750139 0 0 159 0;}
@font-face
	{font-family:新宋体;
	panose-1:2 1 6 9 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:"\@新宋体";
	panose-1:2 1 6 9 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:11.0pt;
	font-family:Calibri;
	mso-fareast-font-family:宋体;
	mso-bidi-font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-noshow:yes;
	mso-style-link:"页眉 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	mso-pagination:none;
	tab-stops:center 207.65pt right 415.3pt;
	layout-grid-mode:char;
	border:none;
	mso-border-bottom-alt:solid windowtext .75pt;
	padding:0cm;
	mso-padding-alt:0cm 0cm 1.0pt 0cm;
	font-size:9.0pt;
	font-family:Calibri;
	mso-fareast-font-family:宋体;
	mso-bidi-font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-noshow:yes;
	mso-style-link:"页脚 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:none;
	tab-stops:center 207.65pt right 415.3pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:Calibri;
	mso-fareast-font-family:宋体;
	mso-bidi-font-family:"Times New Roman";
	mso-font-kerning:1.0pt;}
span.Char
	{mso-style-name:"页眉 Char";
	mso-style-noshow:yes;
	mso-style-locked:yes;
	mso-style-link:页眉;
	mso-ansi-font-size:9.0pt;
	mso-bidi-font-size:9.0pt;
	font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
span.Char0
	{mso-style-name:"页脚 Char";
	mso-style-noshow:yes;
	mso-style-locked:yes;
	mso-style-link:页脚;
	mso-ansi-font-size:9.0pt;
	mso-bidi-font-size:9.0pt;
	font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;
	mso-footnote-separator:url("/web/20171109105730im_/http://www.longene.org/techdoc/0409875001314757116.files/header.html") fs;
	mso-footnote-continuation-separator:url("/web/20171109105730im_/http://www.longene.org/techdoc/0409875001314757116.files/header.html") fcs;
	mso-endnote-separator:url("/web/20171109105730im_/http://www.longene.org/techdoc/0409875001314757116.files/header.html") es;
	mso-endnote-continuation-separator:url("/web/20171109105730im_/http://www.longene.org/techdoc/0409875001314757116.files/header.html") ecs;}
@page Section1
	{size:612.0pt 792.0pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:36.0pt;
	mso-footer-margin:36.0pt;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:154883417;
	mso-list-type:hybrid;
	mso-list-template-ids:-342464354 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l0:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:66.0pt;
	text-indent:-21.0pt;
	mso-bidi-font-family:"Times New Roman";}
@list l1
	{mso-list-id:217131954;
	mso-list-type:hybrid;
	mso-list-template-ids:778858358 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l2
	{mso-list-id:482161781;
	mso-list-type:hybrid;
	mso-list-template-ids:1006640138 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l2:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l3
	{mso-list-id:562715757;
	mso-list-type:hybrid;
	mso-list-template-ids:391012986 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l3:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	mso-bidi-font-family:"Times New Roman";}
@list l4
	{mso-list-id:755176611;
	mso-list-type:hybrid;
	mso-list-template-ids:-1446456912 67698689 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l4:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l5
	{mso-list-id:1025210943;
	mso-list-type:hybrid;
	mso-list-template-ids:294179030 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l5:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	mso-bidi-font-family:"Times New Roman";}
@list l6
	{mso-list-id:1084834327;
	mso-list-type:hybrid;
	mso-list-template-ids:1052281046 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l6:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l7
	{mso-list-id:1256549094;
	mso-list-type:hybrid;
	mso-list-template-ids:1861013078 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l7:level1
	{mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	mso-bidi-font-family:"Times New Roman";}
@list l8
	{mso-list-id:1327712209;
	mso-list-type:hybrid;
	mso-list-template-ids:-542736058 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l8:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l9
	{mso-list-id:1629774870;
	mso-list-type:hybrid;
	mso-list-template-ids:-103397694 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l9:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:21.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l10
	{mso-list-id:1821381938;
	mso-list-type:hybrid;
	mso-list-template-ids:-888008810 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l10:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l11
	{mso-list-id:1825660878;
	mso-list-type:hybrid;
	mso-list-template-ids:1872807842 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l11:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:42.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l12
	{mso-list-id:1837383007;
	mso-list-type:hybrid;
	mso-list-template-ids:766126570 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l12:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l13
	{mso-list-id:1852257558;
	mso-list-type:hybrid;
	mso-list-template-ids:1909109866 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l13:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
@list l14
	{mso-list-id:2058119097;
	mso-list-type:hybrid;
	mso-list-template-ids:2097688580 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l14:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F06C;
	mso-level-tab-stop:none;
	mso-level-number-position:left;
	margin-left:45.0pt;
	text-indent:-21.0pt;
	font-family:Wingdings;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:普通表格;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:Calibri;
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="2050"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
<style>hcfy-result.__hcfy__result__loaded__.__hcfy__result__both__{border: 1px dotted}</style></head>

<body lang="ZH-CN" style="tab-interval:36.0pt;text-justify-trim:punctuation"><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" lang="en" style="display: block; direction: ltr;">
</div><div id="wm-ipp-print">The Wayback Machine - https://web.archive.org/web/20171109105730/http://www.longene.org:80/techdoc/0409875001314757116.html</div>
<script type="text/javascript">
__wm.bt(675,27,25,2,"web","http://www.longene.org/techdoc/0409875001314757116.html","20171109105730",1996,"/_static/",["/_static/css/banner-styles.css?v=fantwOh2","/_static/css/iconochive.css?v=qtvMKcIJ"], false);
  __wm.rw(1);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->

<div class="Section1">

<p class="MsoNormal" align="center" style="text-align:center;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span style="font-size:26.0pt;font-family:新宋体;mso-hansi-font-family:Calibri;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">关于SMP<o:p></o:p></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:12.0pt;font-family:新宋体;
mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">对称式多处理器</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(Symmetric
Multi-Processor)</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">，缩写为</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">，是一种计算机系统结构。多处理器结构有两种：</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l13 level1 lfo1;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">对称</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN"> ―― </span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">多个处理器都是等价的，线程每次受调度运行时都可以动态选择在任何一个处理器上运行。</span><span style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l13 level1 lfo1;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">非对称</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"> ―― </span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">处理器的结构、能力、所处的部位、和作用都各不相同，不同的线程只能在特定的处理器上运行。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">如果一个软件可以在</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">结构的计算机上正常运行，就称为“</span><span style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">安全”</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"> (</span><span style="font-size:
12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">“</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP
Safe</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">”</span><span style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">)</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">。</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">操作系统是整个系统的核心，所以操作系统是否“</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">安全”，或者说是否支持</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:
12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">，就是个关键性的问题。</span><span style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">那么什么样的软件才是“</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">安全”的呢？</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">软件是作为线程在操作系统上运行的，而线程每次受调度运行时又都可以动态选择在</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">结构中的任何一个处理器上运行，软件之是否“</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">安全”，实际上取决于线程之间的互相作用。下面的讨论都以两个线程</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">和</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">T2</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">为例，但实际上也适用于更多个线程。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">首先，假定两个线程分属两个不同的进程，并且互相之间也没有共享内存、不访问共同的外设，那么它们就是“井水不犯河水”，各做各的事情，跟系统是否</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">结构无关，所以天然就是“</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">SMP</span><span style="font-size:
12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">安全”的。即使两个线程在执行相同的代码，也是如此</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">(</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">只要在运行过程中不会修改代码段就行</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">)</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">。</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:21.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><!--[if gte vml 1]><v:group id="_x0000_s1026" style='position:absolute;
 left:0;text-align:left;margin-left:75pt;margin-top:6.15pt;width:285pt;
 height:160.5pt;z-index:1' coordorigin="3300,10260" coordsize="5700,3210">
 <v:group id="_x0000_s1027" style='position:absolute;left:3813;top:10260;
  width:1317;height:675' coordorigin="3855,10500" coordsize="1317,675">
  <v:oval id="_x0000_s1028" style='position:absolute;left:3855;top:10500;
   width:1317;height:675'/>
  <v:shapetype id="_x0000_t202" coordsize="21600,21600" o:spt="202" path="m,l,21600r21600,l21600,xe">
   <v:stroke joinstyle="miter"/>
   <v:path gradientshapeok="t" o:connecttype="rect"/>
  </v:shapetype><v:shape id="_x0000_s1029" type="#_x0000_t202" style='position:absolute;
   left:4062;top:10680;width:813;height:390' filled="f" stroked="f">
   <v:textbox>
    <![if !mso]>
    <table cellpadding=0 cellspacing=0 width="100%">
     <tr>
      <td><![endif]>
      <div>
      <p class=MsoNormal><span lang=EN-US>CPU 1</span></p>
      </div>
      <![if !mso]></td>
     </tr>
    </table>
    <![endif]></v:textbox>
  </v:shape></v:group><v:group id="_x0000_s1030" style='position:absolute;
  left:6735;top:10275;width:1317;height:675' coordorigin="3855,10500"
  coordsize="1317,675">
  <v:oval id="_x0000_s1031" style='position:absolute;left:3855;top:10500;
   width:1317;height:675'/>
  <v:shape id="_x0000_s1032" type="#_x0000_t202" style='position:absolute;
   left:4062;top:10680;width:813;height:390' filled="f" stroked="f">
   <v:textbox>
    <![if !mso]>
    <table cellpadding=0 cellspacing=0 width="100%">
     <tr>
      <td><![endif]>
      <div>
      <p class=MsoNormal><span lang=EN-US>CPU 2</span></p>
      </div>
      <![if !mso]></td>
     </tr>
    </table>
    <![endif]></v:textbox>
  </v:shape></v:group><v:shape id="_x0000_s1033" type="#_x0000_t202" style='position:absolute;
  left:3735;top:11400;width:1560;height:480'>
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal align=center style='text-align:center'><span
     lang=EN-US>Cache 1 </span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1034" type="#_x0000_t202" style='position:absolute;
  left:6660;top:11400;width:1560;height:480'>
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal align=center style='text-align:center'><span
     lang=EN-US>Cache 2 </span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shape id="_x0000_s1035" type="#_x0000_t202" style='position:absolute;
  left:3300;top:12510;width:5700;height:960'>
  <v:textbox>
   <![if !mso]>
   <table cellpadding=0 cellspacing=0 width="100%">
    <tr>
     <td><![endif]>
     <div>
     <p class=MsoNormal align=center style='text-align:center'><span
     style='font-family:宋体;mso-ascii-font-family:Calibri;mso-hansi-font-family:
     Calibri'>内存</span></p>
     </div>
     <![if !mso]></td>
    </tr>
   </table>
   <![endif]></v:textbox>
 </v:shape><v:shapetype id="_x0000_t32" coordsize="21600,21600" o:spt="32"
  o:oned="t" path="m,l21600,21600e" filled="f">
  <v:path arrowok="t" fillok="f" o:connecttype="none"/>
  <o:lock v:ext="edit" shapetype="t"/>
 </v:shapetype><v:shape id="_x0000_s1036" type="#_x0000_t32" style='position:absolute;
  left:3570;top:11880;width:165;height:630;flip:x' o:connectortype="straight">
  <v:stroke dashstyle="dash"/>
 </v:shape><v:shape id="_x0000_s1037" type="#_x0000_t32" style='position:absolute;
  left:5130;top:11880;width:165;height:630;flip:x' o:connectortype="straight">
  <v:stroke dashstyle="dash"/>
 </v:shape><v:shape id="_x0000_s1038" type="#_x0000_t32" style='position:absolute;
  left:5940;top:11880;width:720;height:630;flip:x' o:connectortype="straight">
  <v:stroke dashstyle="dash"/>
 </v:shape><v:shape id="_x0000_s1039" type="#_x0000_t32" style='position:absolute;
  left:7500;top:11880;width:720;height:630;flip:x' o:connectortype="straight">
  <v:stroke dashstyle="dash"/>
 </v:shape><v:shapetype id="_x0000_t70" coordsize="21600,21600" o:spt="70"
  adj="5400,4320" path="m10800,l21600@0@3@0@3@2,21600@2,10800,21600,0@2@1@2@1@0,0@0xe">
  <v:stroke joinstyle="miter"/>
  <v:formulas>
   <v:f eqn="val #1"/>
   <v:f eqn="val #0"/>
   <v:f eqn="sum 21600 0 #1"/>
   <v:f eqn="sum 21600 0 #0"/>
   <v:f eqn="prod #1 #0 10800"/>
   <v:f eqn="sum #1 0 @4"/>
   <v:f eqn="sum 21600 0 @5"/>
  </v:formulas>
  <v:path o:connecttype="custom" o:connectlocs="10800,0;0,@0;@1,10800;0,@2;10800,21600;21600,@2;@3,10800;21600,@0"
   o:connectangles="270,180,180,180,90,0,0,0" textboxrect="@1,@5,@3,@6"/>
  <v:handles>
   <v:h position="#0,#1" xrange="0,10800" yrange="0,10800"/>
  </v:handles>
 </v:shapetype><v:shape id="_x0000_s1040" type="#_x0000_t70" style='position:absolute;
  left:4305;top:10950;width:435;height:450'/>
 <v:shape id="_x0000_s1041" type="#_x0000_t70" style='position:absolute;left:7230;
  top:10935;width:435;height:450'/>
</v:group><![endif]--><!--[if !vml]--><span style="mso-ignore:vglayout">

<table cellpadding="0" cellspacing="0" align="left">
 <tbody><tr>
  <td width="99" height="7"></td>
 </tr>
 <tr>
  <td></td>
  <td><img width="386" height="218" src="./关于SMP_files/image001.gif" v:shapes="_x0000_s1026 _x0000_s1027 _x0000_s1028 _x0000_s1029 _x0000_s1030 _x0000_s1031 _x0000_s1032 _x0000_s1033 _x0000_s1034 _x0000_s1035 _x0000_s1036 _x0000_s1037 _x0000_s1038 _x0000_s1039 _x0000_s1040 _x0000_s1041"></td>
 </tr>
</tbody></table>

</span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span></p>

<br style="mso-ignore:vglayout" clear="ALL">

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">总之，一般而言，只有可以被多个线程共享的变量才有冲突，因而才需要“互斥”，即在一个线程访问共享变量时不允许别的线程前来干扰。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">如果两个线程属于同一个进程，那么由于共享同一个用户空间，互相之间就可能有冲突了。引起这种冲突的原因可能有：</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l11 level1 lfo2;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">全局变量</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">(</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">包括</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">static</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">局部量</span><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">)</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">，或者更确切地说是“共享量”。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l11 level1 lfo2;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">队列</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l11 level1 lfo2;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">共享内存</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">下面举例说明这个问题。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">假定线程</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">和</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">T2</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">同时执行到了下面这个函数，而只有细微的先后差别。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">struct</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> msg_queue *create_msg_queue(<span style="color:blue">struct</span>
w32thread *thread, <span style="color:blue">struct</span> thread_input *input)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> msg_queue *queue;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">……</span><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>status
= create_object(KernelMode, ……, (PVOID *)&amp;queue);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (NT_SUCCESS(status) &amp;&amp; queue) {<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>thread-&gt;queue
= queue;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> queue;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">这里的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">thread</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">形式上不是全局量</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">但实质上是。这是因为</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">内核中关于线程的数据结构是全局的</span><span style="font-size:
12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">具体线程的</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;color:blue;mso-font-kerning:
0pt;mso-no-proof:yes">struct</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes"> w32thread</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">数据结构并不是只有本线程才能访问，别的线程也有可能访问它。比方说：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">struct</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> msg_queue *get_current_queue(<span style="color:blue">void</span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
color:blue;mso-font-kerning:0pt;mso-no-proof:yes">struct</span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"> msg_queue *queue =
current_thread-&gt;queue;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;color:blue;mso-font-kerning:
0pt;mso-no-proof:yes">if</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"> (!queue)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:36.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">queue = create_msg_queue(<b style="mso-bidi-font-weight:normal">current_thread</b>, NULL);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;color:blue;mso-font-kerning:
0pt;mso-no-proof:yes">return</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"> queue;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">这里访问的是本线程自身的数据结构。然而：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">int</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> attach_thread_input(<span style="color:blue">struct</span>
w32thread *thread_from, <span style="color:blue">struct</span> w32thread
*thread_to)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (!thread_to-&gt;queue &amp;&amp;
!(thread_to-&gt;queue = create_msg_queue(<b style="mso-bidi-font-weight:normal">thread_to</b>,
NULL)))<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> 0;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> 1;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">这里的</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt">thread_to</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">却是另一个线程的数据结构。所以</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">T1</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">和</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">T2</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">完全有可能从不同的路径同时进入</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">create_msg_queue()</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">这个函数，而赋值语句“</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">thread-&gt;queue = queue</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">”中的指针</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes">thread</span><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">则指向同一个数据结构。</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">于是，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">T1</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">和</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes">T2</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">在这个函数中各自分配了一个</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">msg_queue</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">数据结构，然后假定</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">T1</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">先完成赋值，然后</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">T2</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">又来赋值，则</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">thread-&gt;queue</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">被覆盖，</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes">T1</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">所分配的那个数据结构就丢失了。这不但会引起内存泄漏，还可能引起程序中的混乱。当然，之所以如此是因为这里有对于全局量的写操作，如果两个线程都只是读就不会有问题。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">但是，回到前面的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">create_msg_queue()</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">，为什么会有这样的问题，怎样才能避免这样的问题呢？问题在于，对</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">create_msg_queue()</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">的调用应该是有条件的，那就是指针</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">thread-&gt;queue</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">为空，正如</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">get_current_queue()</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">的代码所示：</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:22.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:21.0pt;mso-para-margin-left:
2.0gd;text-align:left;text-indent:24.0pt;mso-layout-grid-align:none;text-autospace:
none"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;
color:blue;mso-font-kerning:0pt;mso-no-proof:yes">if</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes"> (!queue)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:21.0pt;mso-para-margin-left:
2.0gd;text-align:left;text-indent:36.0pt;line-height:125%;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">queue
= create_msg_queue(<b style="mso-bidi-font-weight:normal">current_thread</b>,
NULL);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">这个条件语句的执行应该是不可分割的，也就是“原子的”。也就是说，如果一个线程检测到指针</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">queue</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">为空，那就一定要做完了</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">create_msg_queue()</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">并完成赋值以后才可允许别的线程检测这个指针是否为空。否则的话，如果有两个线程“同时”捡测到指针</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">queue</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">为空，那就注定其中之一所创建的队列会丢掉了。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">但是</span><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">对于局部量的访问</span></b><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">就<b style="mso-bidi-font-weight:normal">一般不存在冲突的问题</b>，因为局部量在堆栈上，不同的线程各有自己的堆栈，所以不会发生冲突。例如，假定</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">和</span><span style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">T2</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">同时执行到了这里的赋值语句：</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">int</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> attach_thread_input(<span style="color:blue">struct</span>
w32thread *thread_from, <span style="color:blue">struct</span> w32thread
*thread_to)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> desktop *desktop;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> thread_input *input;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:22.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp; </span><b style="mso-bidi-font-weight:
normal">input = (<span style="color:blue">struct</span> thread_input
*)grab_object(thread_to-&gt;queue-&gt;input)</b>;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> 1;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">}</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">只要参数</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes">thread_to</span><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">不同，这里</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">grab_object()</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">的返回值就很可能不同，那指针</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">input</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">的值是否有可能被覆盖呢？不会。这是因为</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">T1</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">和</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">T2</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">的局部量</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">input</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">在不同的堆栈上，它们只是同名，但实际上是两个不同的变量。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">因此，局部量一般不存在是否</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">“</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">安全”</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">的问题。但是这并不表示局部量就不会有问题，因为<b style="mso-bidi-font-weight:normal">有些形式上的局部量实质上是全局量</b>。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">队列一般都是共享的</span></b><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，逻辑上相当于全局量，而且队列操作一般都带有写操作，所以队列操作最容易引起这样的冲突。例如：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">insert_obdir_entry(<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
POBJECT_DIRECTORY Directory,<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
PVOID Object<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">HeadDirectoryEntry =
Directory-&gt;LookupBucket;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NewDirectoryEntry
= (POBJECT_DIRECTORY_ENTRY)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:36.0pt;text-align:left;
text-indent:36.0pt;line-height:125%;mso-layout-grid-align:none;text-autospace:
none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">kmalloc(<span style="color:blue">sizeof</span>(OBJECT_DIRECTORY_ENTRY), GFP_KERNEL);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>……</span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* insert at the bucket chain head */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NewDirectoryEntry-&gt;ChainLink
= *HeadDirectoryEntry;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*HeadDirectoryEntry
= NewDirectoryEntry;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NewDirectoryEntry-&gt;Object
= Object;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:
1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:23.25pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">这是单链的队列操作。如果</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">T1</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">和</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">T2</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">同时执行到这里</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，就可能会发生这样的情况：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo6;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-no-proof:
yes"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">参数</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Directory</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">指向同一个目录，所以两个线程的</span><span lang="EN-US" style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">HeadDirectoryEntry</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">相等。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo6;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">但是两个线程各自分配了</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:
yes">NewDirectoryEntry</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo6;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">两个线程也各有自己的</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">Object</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo6;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">时间上</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">T1</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">比</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">T2</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">略为领先。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:42.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l10 level1 lfo6;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">于是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">T1</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">NewDirectoryEntry</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">就丢失了，属于</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">T1</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">的对象</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">Object</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">也没有进入目录。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">同样，这里也因丢失数据结构而造成了内存泄漏，并且这样一来程序的逻辑也错了。</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">简单的单链队列尚且如此，双链就更不用说了。例如：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">inline</span> <span style="color:blue">void</span> list_add_after(<span style="color:blue">struct</span>
list_head *elem, <span style="color:blue">struct</span> list_head *to_add)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>to_add-&gt;next
= elem-&gt;next;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>to_add-&gt;prev
= elem;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>elem-&gt;next-&gt;prev
= to_add;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>elem-&gt;next
= to_add;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">显然，这段程序所实现的操作应该是原子操作，如果这个操作的原子性得不到保证，就肯定会出问题。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">所以队列操作是最容易出问题的操作，只要可能有</span><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">多个线程并发访问同一个队列</span></b><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">就是</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">容易出问题的地方。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">那么</span><b style="mso-bidi-font-weight:
normal"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">什么情况下会有多个线程并发访问同一个队列</span></b><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">呢？一般而言有这么一些：</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">一、显式</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l8 level1 lfo3;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">通过</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">fork()</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">为同一段程序生成多个线程。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l8 level1 lfo3;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">遵循生产者</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">/</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">消费者模型的操作，这里面又有一对一、一对多、多对一、多对多等几种情况。（线程间通信也属于这种模型，不过线程间通信由系统提供，可以认为是安全的）。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l8 level1 lfo3;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">在内核中，由于队列存在于共享的系统空间，多线程与多进程在这个问题上是等价的。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:36.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">二、隐式</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l12 level1 lfo4;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span style="font-size:12.0pt;
line-height:125%;font-family:Wingdings;mso-fareast-font-family:Wingdings;
mso-bidi-font-family:Wingdings;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">中断服务程序和</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">bh</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">函数都是</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">“</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">盗用</span><span style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">”</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">当前线程的上下文执行的，所以应认为系统中所有线程的程序中都包括（所有的）中断服务程序和</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">bh</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">函数。特别要注意的是，由于中断服务程序和</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">bh</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">函数的存在，还可能发生同一个线程嵌套访问一个队列的情况。例如，假定</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">正在把一个包挂入双链的发送队列，尚在修改指针的中途，此时发生了一个中断，并因此而需要从发送队列中摘下一个包。由于此时的当前线程就是</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">，就发生了</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">嵌套访问同一个双链队列，既要挂入一个包、又要摘下一个包的情况。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">由此可见，队列操作是十分敏感，很容易出问题的操作</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">至于共享内存，实质上也相当于全局量，所以也是可能出问题的操作。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">上述所有的情景，之所以会有问题，就是因为本来应该作为一个整体的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">原子操作</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">被拆散了，中间插进了针对相同目标的其它操作。也就是说，一些操作对于原子性的要求没有得到满足。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">所谓</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">操作</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，是个比较模糊的概念，大到一个程序，小到一条指令，都有可能被看作是一个操作，所以具体的操作有规模大小的问题，我们称之为</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">粒度</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">。另一方面，也不是所有的操作都有原子性的要求。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">如果有一种有原子性要求的操作、其粒度小到一条指令，只用一条指令就可完成，那么这个操作的原子性要求在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中就是可以满足的。这是因为，在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，单条指令的执行是不可分割的。所谓不可分割，是说在单条指令的执行过程中不会有别的操作插进来，所以这个操作对于所操作的对象是独占的。相比之下，如果一个操作要由连续两条指令才能完成，那就可能会有别的操作插进来了。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，有别的操作插进来的原因只有一个，那就是中断。注意，单条指令在执行过程中是不会发生中断的，中断只能发生在两条指令之间。如果发生中断，那么插进来的至少有中断服务程序，在多线程的系统中还可能引起调度。而如果引起了调度，那么这中间有多少个线程会插进来就不可预测了。总之，在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，只要一个操作的粒度小到可以由单条指令完成，那么这个操作的原子性要求就是可以满足的。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">可是，在多</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，情况又不同了。<b style="mso-bidi-font-weight:normal">在多</b></span><b style="mso-bidi-font-weight:
normal"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span></b><b style="mso-bidi-font-weight:
normal"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，即使一个操作可以由单条指令完成，也不能保证其原子性</span></b><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">。这是因为此时中断已不再是破坏原子性的唯一原因，更大的问题在于多个</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">对于内存的共享。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">下面举个例子加以说明。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">X86</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">架构的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">有条指令</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">XADD</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">Intel</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">的手册中关于这条指令的定义是这样：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:52.5pt;mso-para-margin-left:
5.0gd;text-align:left;line-height:125%;mso-layout-grid-align:none;text-autospace:
none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">TEMP &lt;= SRC + DEST<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:52.5pt;mso-para-margin-left:
5.0gd;text-align:left;line-height:125%;mso-layout-grid-align:none;text-autospace:
none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">SRC &lt;= DEST<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:52.5pt;mso-para-margin-left:
5.0gd;text-align:left;line-height:125%;mso-layout-grid-align:none;text-autospace:
none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">DEST &lt;= TEMP<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:52.5pt;mso-para-margin-left:
5.0gd;text-align:left;line-height:125%;mso-layout-grid-align:none;text-autospace:
none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">这条指令的操作数</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt">DEST</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">是操作的目标，</span><span style="font-size:
12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">一般</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">是内存中的一个变量；</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt">SRC</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">一般也是一个变量，而</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">TEMP</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">则是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">内部用作草稿的一个寄存器。事实上，这条指令是专门用来实现临界区的，其执行包括三个微操作，需要三个时钟周期</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">(</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">取指令不算在内</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">)</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">。显而易见，如果在指令执行的时候有另一个</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">也对同一个内存单元执行这条指令，并且时间上只相差一个时钟周期，就会发生运行于两个</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">上的两个线程同时进入临界区的错误。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">由此可见，在多</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，即使能以单条指令完成的操作也不能保证其原子性了，只有粒度小到单个时钟周期程度的操作才能保证其原子性。为此，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">x86</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">架构的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">允许在执行某些指令时<b style="mso-bidi-font-weight:normal">锁住总线</b>，写程序时可以在汇编指令前面加上前缀</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">LOCK</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">。不过，并非所有的指令都可以加</span><span lang="EN-US" style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">LOCK</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，而只允许在少数指令上加</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">LOCK</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">，允许加</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">LOCK</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">的指令限于</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">读</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">-</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">处理</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">-</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">写</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">模式的操作，主要用来实现临界区。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">总之，上述所有的情景，对于单核的多线程操作就有问题，对于多核系统则更有问题。实际上，线程本质上就是对于</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的虚拟，而单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的多线程系统本质上就是虚拟的多</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统。但是，在单核的多线程系统中，实际的执行是经过</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">串行化</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的，物理的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">只有一个，只是在不同的时间中用于不同的线程，两个不同线程不会在同一个物理时间点上发生冲突。而多核系统中的不同</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，则有可能在同一个物理时间点上发生冲突，所以更难以保证其原子性。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">那么，哪一些操作应该是原子的，又怎样才能保证这些操作的原子性呢？</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">先看<b style="mso-bidi-font-weight:normal">哪一些操作应该是原子的</b>：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l4 level1 lfo8;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">对同一个变量的修改（读出</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">-</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">改变</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">-</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">回写）。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l4 level1 lfo8;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">队列操作。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l4 level1 lfo8;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">某些赋值操作。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l4 level1 lfo8;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">其它需要放在临界区中完成的操作序列。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">再考虑<b style="mso-bidi-font-weight:normal">怎样保证原子性</b>的问题。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">先看在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的多线程系统怎么保证操作的原子性：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;line-height:125%;mso-layout-grid-align:none;
text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的多线程系统中，要保证用户空间的操作的原子性，就只有两个办法：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l2 level1 lfo9;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">放在同一条指令中完成。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l2 level1 lfo9;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">放在临界区中完成。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:24.0pt;text-align:left;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">对于用户空间的程序，要切记：任何两条指令之间都可以发生中断和线程切换。因此，只要一个原子操作的粒度超过单条指令，就一定要放在临界区中。另一方面，只要把操作放在了临界区中，一般而言就是安全的。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:24.0pt;text-align:left;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:24.0pt;text-align:left;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">而如果是在内核中，那么情况有所不同：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l2 level1 lfo9;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">在内核中，并非任何两条指令之间都可以发生中断，并可以在程序中关中断，形成一个“中断禁区”。中断禁区中既然不会发生中断，则自然也不会发生（被动的）调度，所以同时又是“调度禁区”。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l2 level1 lfo9;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">即使发生中断，也不一定可以发生线程切换，具体取决于调度策略：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:66.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l0 level1 lfo10;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><span style="mso-list:Ignore">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">如果是实时调度，那么应该认为任何两条指令之间都可以发生线程切换（实际上在中断服务程序里面是不会发生切换的）。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:66.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l0 level1 lfo10;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><span style="mso-list:Ignore">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">如果是非实时调度，那么基本上不会发生线程切换。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l14 level1 lfo11;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">除</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">调度策略的影响外，在程序中还可以禁止调度，形成一个“调度禁区”。在调度禁区中仍可发生中断，但不会发生调度。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l14 level1 lfo11;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">有些原子操作光是放在普通的临界区中还不够，还需要把中断关掉。例如，假定中断服务程序从网卡读包，并将包挂入接收队列；而应用程序通过系统调用从接收队列摘包，那就要用</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">临界区</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">+</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">关中断</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的方案解决。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:24.0pt;text-align:left;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">由此可见，不管是用户空间还是系统空间，<b style="mso-bidi-font-weight:
normal">临界区是个保证操作原子性的基本手段</b>。除临界区外，在内核中也可以用调度禁区和中断禁区保证操作的原子性。其中调度禁区可以防止不同线程之间的冲突，而中断禁区可以防止（因中断引起的）同一线程的自相冲突。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">至于临界区的实现，在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">和多</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统中又有不同的考虑。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，临界区要防止的是不同线程针对共享变量的操作的穿插和混合，以实现有序的串行化。这决定了：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">一时不能进入临界区的线程必须让出</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">（这是系统中唯一的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">），使已经进入临界区的线程有机会完成其操作并退出临界区。换言之，在进不了临界区的时候必须睡眠等待。与此相应，每当有线程从临界区退出时必须唤醒可能正在睡眠等待的线程。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">但是，在多</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统中，则有所不同：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l14 level1 lfo11;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">不存在必须让出</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">的问题，因为有多个</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l14 level1 lfo11;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">要让出</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">就要用到睡眠</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">/</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">唤醒的机制，既有系统开销代价可能太大的问题，也有时间延迟的问题，具体要看（临界区中）原子操作的大小。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l14 level1 lfo11;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:Wingdings;mso-fareast-font-family:
Wingdings;mso-bidi-font-family:Wingdings;mso-font-kerning:0pt"><span style="mso-list:Ignore">l<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">实际上原子操作一般都是不大的，让一时不能进入临界区的线程空转等待往往更好。如果采用空转等待，那就是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">“</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">空转锁</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">、即</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">所以：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l5 level1 lfo14;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><span style="mso-list:Ignore">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">也是用来实现临界区的，但</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">只可用于</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">SMP</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">结构的系统；</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l5 level1 lfo14;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><span style="mso-list:Ignore">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">而普通临界区既可用于单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统，也可用于</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">SMP</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">另一方面：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l3 level1 lfo15;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><span style="mso-list:Ignore">1.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统只可以用普通临界区，而不能用</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="margin-left:45.0pt;text-align:left;
text-indent:-21.0pt;line-height:125%;mso-list:l3 level1 lfo15;mso-layout-grid-align:
none;text-autospace:none"><!--[if !supportLists]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><span style="mso-list:Ignore">2.<span style="font:7.0pt &quot;Times New Roman&quot;">&nbsp; </span></span></span><!--[endif]--><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">SMP</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统二者都可以用，但是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">的效率较高。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">不过，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">是一种特殊的临界区。它的特殊之处在于：对于在不同</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">上运行的线程，它是临界区；而对于同一个</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">上的线程，则是调度禁区或中断禁区。或者说，它是跨</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">的临界区，又是同一</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">上的调度禁区或中断禁区。这样，在多</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">的系统上，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">首先表现为调度禁区（或中断禁区），同时它又是个临界区，总之就是在同一时间内只有一个线程可以进入这个禁区和临界区。而在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">的系统上，则</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">就是一个调度禁区（或中断禁区），由于是调度禁区，就不会有（同一</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">上的）其它线程进入，所以临界区就形同虚设、名存实亡。这就保证了在单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统上任何线程都不会被拦在</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">临界区之外，因为根本就不存在竞争。正因为这样，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">既可用于多</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统，起着调度禁区加临界区的作用；也可用于单</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统，此时只起调度禁区的作用。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">另外还有个办法，就是采用</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">Spinlock</span><span style="font-size:12.0pt;line-height:
125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">和普通临界区的结合，就是不能进入临界区的线程先空转上几圈，如果转上几圈还是进不去就转入睡眠，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt">Wine</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">代码中用来实现临界区的</span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">EnterCriticalSection()</span><span style="font-size:11.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">就是这样</span><span style="font-size:12.0pt;line-height:125%;font-family:
宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">在</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:宋体;mso-font-kerning:0pt">Wine</span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">的代码中，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">EnterCriticalSection()</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">实际上是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">RtlEnterCriticalSection()</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，这一点从</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">kernell32</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">spec</span><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">文件中可以看出：</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">@ stdcall
EnterCriticalSection(ptr) <span style="mso-spacerun:yes">&nbsp;</span>ntdll.RtlEnterCriticalSection</span><span lang="EN-US" style="font-size:11.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">RtlEnterCriticalSection()</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">的代码在</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">ntdll/critsection.c</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">中</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">：</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">NTSTATUS
WINAPI RtlEnterCriticalSection( RTL_CRITICAL_SECTION *crit )<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span>
(crit-&gt;SpinCount)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>ULONG count;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (RtlTryEnterCriticalSection( crit )) <span style="color:blue">return</span> STATUS_SUCCESS;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">for</span> (<b style="mso-bidi-font-weight:normal">count =
crit-&gt;SpinCount</b>; <b style="mso-bidi-font-weight:normal">count &gt; 0</b>;
<b style="mso-bidi-font-weight:normal">count--</b>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:blue">if</span> (crit-&gt;LockCount &gt; 0) <span style="color:blue">break</span>;<span style="mso-spacerun:yes">&nbsp; </span><span style="color:green">/* more than one waiter, don't bother spinning */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:blue">if</span> (crit-&gt;LockCount == -1)<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* try again */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:blue">if</span> (interlocked_cmpxchg(
&amp;crit-&gt;LockCount, 0, -1 ) == -1) <span style="color:blue">goto</span>
done;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>small_pause();<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span>
(interlocked_inc( &amp;crit-&gt;LockCount ))<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (crit-&gt;OwningThread ==
ULongToHandle(GetCurrentThreadId()))<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>crit-&gt;RecursionCount++;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:blue">return</span> STATUS_SUCCESS;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* Now wait for it */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>RtlpWaitForCriticalSection( crit );<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">done:<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>crit-&gt;OwningThread<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>=
ULongToHandle(GetCurrentThreadId());<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>crit-&gt;RecursionCount = 1;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span>
STATUS_SUCCESS;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">我们知道</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">Wine</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">的代码分两部分</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">一部分是</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt">DLL</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">另一部分是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">Wine Server</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">。前者已经考虑到对于</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">SMP</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">的支持</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">凡有原子性要求的操作都已用</span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">EnterCriticalSection()</span><span style="font-size:11.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">和</span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">LeaveCriticalSection()</span><span style="font-size:11.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">加以保护，而</span><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">EnterCriticalSection()</span><span style="font-size:11.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">就是</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">RtlEnterCriticalSection()</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">而</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">Wine Server</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">则原来的设计是一台机器上只有一个服务线程</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">而服务线程的操作</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">又是在主循环中每次处理一个请求，是完全串行化的，因而天然就是原子性的，所以不需要用临界区加以保护。但是，移到内核中以后就不一样了。原来的主循环已不复存在，对请求的处理转化成系统调用，分散到了各个线程自己的上下文中，所以现在的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">module_2.6.34</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">是完全不支持</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">SMP</span><span style="font-size:12.0pt;line-height:125%;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">的，这就是我们下一步要解决的问题。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">下面，我们看一下</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">module_2.6.34</span><span style="font-size:12.0pt;
line-height:125%;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">的代码中一些有问题的操作。</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:12.0pt;font-family:新宋体;
mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;
mso-ansi-language:ZH-CN">一、在</span><span lang="EN-US" style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">sock/sock.c</span><span style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">中</span><span style="font-size:
12.0pt;font-family:新宋体;mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:Calibri;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">struct</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> sock<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>.....<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> list_head<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>accentry;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:green">/*
entry in the list below for the request */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> list_head<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>paccepts;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:green">/*
pending accepts on this socket */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> async_queue *read_q;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* queue for asynchronous reads */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> async_queue *write_q;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* queue for asynchronous writes */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">};</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case A1</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
color:blue;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">if</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> (!sock-&gt;read_q &amp;&amp; !(sock-&gt;read_q =
create_async_queue(sock-&gt;fd)))</span><span lang="EN-US" style="font-size:11.0pt;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt"> ...<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">假定有两个线程T1和T2分别在两个CPU上运行，针对同一个sock，同时执行到了这个地方但T1略微领先，那么T1所分配的</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">async_queue</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">就会因指针被覆盖而丢失，既造成混乱又造成内存泄露。<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>同理，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">sock-&gt;write_q </span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">也是一样。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case A2</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">if</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> (!(async = create_async(current_thread, queue,
data))) ...<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">struct</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> async *create_async(<span style="color:blue">struct</span>
w32thread *thread, <span style="color:blue">struct</span> async_queue *queue, <span style="color:blue">const</span> async_data_t *data)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>list_add_before(&amp;queue-&gt;queue,
&amp;async-&gt;queue_entry);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">如果两个线程</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt">T1</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">和</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">T2</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">同时运行到这儿</span><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">几乎同时进入</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">list_add_before()</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">就会把队列搞乱。</span><span lang="EN-US" style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case A3</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">LIST_FOR_EACH_ENTRY(
acceptsock, &amp;sock-&gt;paccepts, <span style="color:blue">struct</span>
sock, accentry ) ...<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">LIST_FOR_EACH_ENTRY_SAFE(acceptsock,
next, &amp;sock-&gt;paccepts, <span style="color:blue">struct</span> sock,
accentry) ...<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#define</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> LIST_FOR_EACH_ENTRY(elem, list, type, field) \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:blue">for</span>
((elem) = LIST_ENTRY((list)-&gt;next, type, field); \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;(elem)-&gt;field != (list); \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>(elem) = LIST_ENTRY((elem)-&gt;field.next, type, field))<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#define</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> LIST_FOR_EACH_ENTRY_SAFE(cursor, cursor2, list,
type, field) \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:blue">for</span>
((cursor) = LIST_ENTRY((list)-&gt;next, type, field), \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>(cursor2) = LIST_ENTRY((cursor)-&gt;field.next, type, field); \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>&amp;(cursor)-&gt;field != (list); \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>(cursor) = (cursor2), \<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>(cursor2) = LIST_ENTRY((cursor)-&gt;field.next, type, field))<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">在这两种情况下，指针</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">acceptsock</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">最初指向队列头</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">sock-&gt;paccepts</span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">，然后逐个节点推进。如果</span><span style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">T1</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">正在推进中</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">T2</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">正好在进行插入</span><span style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">/</span><span style="font-size:
12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">删除，那就可能造成混乱。所以，只要有对队列造成改变的操作正在进行，就应该禁止扫描队列。</span><span style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">Case </span></b><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">A</span></b><b style="mso-bidi-font-weight:
normal"><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">4: <o:p></o:p></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">list_add(&amp;acceptsock-&gt;accentry,
&amp;dest_sock-&gt;paccepts);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">这里的两个参数，一个是队列中的节点，另一个是要进入队列的新节点。如果两个线程T1和T2同时运行到这儿，几乎同时进入</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">list_add</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">，要在同一个节点后面挂上新的节点，就会造成混乱，并造成内存泄漏。<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>进一步，假定T1要在节点N4后面挂上一个节点，但是恰好T2要删除T2，两个操作同时发生，就更乱套了。<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><b style="mso-bidi-font-weight:
normal"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">Case A5</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">list_remove(&amp;acceptsock-&gt;accentry);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">参考Case4，但更复杂，因为删除节点涉及3个节点。</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:12.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">二、在</span><span lang="EN-US" style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt">ob/object.c</span><span style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">中</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case B1</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">insert_obdir_entry(<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
POBJECT_DIRECTORY Directory,<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
PVOID Object<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* insert at the bucket chain head */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NewDirectoryEntry-&gt;ChainLink
= *HeadDirectoryEntry;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*HeadDirectoryEntry
= NewDirectoryEntry;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>NewDirectoryEntry-&gt;Object
= Object;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">这是单链的队列操作。如果</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">T1</span><span style="font-size:
12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">和</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">T2</span><span style="font-size:
12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">同时执行到这里</span><span style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">，</span><span style="font-size:
12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">就同样会因丢失数据结构</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:12.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">而造成内存泄露。</span><span lang="EN-US" style="font-size:
12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case B2</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">lookup_obdir_entry(<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
POBJECT_DIRECTORY Directory,<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
PUNICODE_STRING Name,<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
ULONG Attributes<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*HeadDirectoryEntry
= DirectoryEntry-&gt;ChainLink;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>DirectoryEntry-&gt;ChainLink
= *(Directory-&gt;LookupBucket);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*(Directory-&gt;LookupBucket)
= DirectoryEntry;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">Case</span></b><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"> B3</span></b><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">:<o:p></o:p></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">delete_obdir_entry
(<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>IN
POBJECT_DIRECTORY Directory<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>HeadDirectoryEntry
= Directory-&gt;LookupBucket;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>DirectoryEntry
= *HeadDirectoryEntry;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*HeadDirectoryEntry
= DirectoryEntry-&gt;ChainLink;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>DirectoryEntry-&gt;ChainLink
= NULL;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:12.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">三、在</span><span lang="EN-US" style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt">msg/queue.c</span><span style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">中</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case C1</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：</span></b><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">struct</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> msg_queue *create_msg_queue(<span style="color:blue">struct</span>
w32thread *thread, <span style="color:blue">struct</span> thread_input *input)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>thread-&gt;queue
= queue; <o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> queue;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Case C2</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">int</span> merge_message(<span style="color:blue">struct</span> thread_input *input, <span style="color:blue">const</span>
<span style="color:blue">struct</span> message *msg)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> message *prev;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> list_head *ptr =
list_tail(&amp;input-&gt;msg_list);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (!ptr)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> 0;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>prev
= LIST_ENTRY(ptr, <span style="color:blue">struct</span> message, entry);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span lang="EN-US" style="font-size:11.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">Case C3:<o:p></o:p></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">void</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> timer_callback(<span style="color:blue">void</span>
*<span style="color:blue">private</span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span lang="EN-US" style="font-size:11.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">......</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>list_remove(ptr);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>list_add_before(&amp;queue-&gt;expired_timers,
ptr);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>set_next_timer(queue);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:11.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">注</span><span style="font-size:11.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">：</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">async_set_result()</span><span style="font-size:11.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">和</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">timer_callback()</span><span style="font-size:11.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN">都调用</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">thread_queue_apc()</span><span style="font-size:11.0pt;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt">，</span><span style="font-size:11.0pt;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:
ZH-CN">可是</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">thread_queue_apc()</span><span style="font-size:11.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN">里面是</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">ktrace(<span style="color:#A31515">"WHA!! please
use NtQueueApcThread\n"</span>)</span><span style="font-size:11.0pt;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">，这个问题要仔细看一下。</span><span lang="EN-US" style="font-size:11.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">struct</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> timer<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> list_head<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span>entry;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* entry in timer list */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>timeout_t<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>when;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:green">/* next expiration */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">int</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>rate;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:green">/* timer rate in ms */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>user_handle_t<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>win;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:green">/* window handle */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">int</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>msg;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style="color:green">/* message to post */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">long</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>id;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* timer id */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">long</span><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>lparam;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* lparam for message */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">};</span><span style="font-size:9.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><b style="mso-bidi-font-weight:
normal"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt;mso-ansi-language:ZH-CN"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;
</span></span></b><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt;mso-ansi-language:ZH-CN">以上只是一个很不完全的统计，下面我们的任务就是仔细看代码，把所有可能引起问题的操作挑出来。<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt;mso-ansi-language:ZH-CN"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>挑出来之后怎么办呢？一般来说就是用spinlock把原子操作保护起来。下面是Linux内核代码中的一些实例，可供参考。<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:11.0pt;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">例一、</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> LIST_HEAD(all_bdevs)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;
</span>__cacheline_aligned_in_smp DEFINE_SPINLOCK(bdev_lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">long</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> nr_blockdev_pages(<span style="color:blue">void</span>)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> block_device *bdev;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">long</span> ret = 0;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_lock(&amp;<b>bdev_lock</b>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>list_for_each_entry(bdev,
&amp;all_bdevs, bd_list) {<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ret
+= bdev-&gt;bd_inode-&gt;i_mapping-&gt;nrpages;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_unlock(&amp;bdev_lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> ret;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:11.0pt;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">例二、</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">void</span> rs_close(<span style="color:blue">struct</span> tty_struct *tty, <span style="color:blue">struct</span>
file * filp)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_lock(&amp;<b>timer_lock</b>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (tty-&gt;count == 1)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>del_timer_sync(&amp;serial_timer);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_unlock(&amp;timer_lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:11.0pt;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">例三、</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">void</span>
mousedev_attach_client(<span style="color:blue">struct</span> mousedev
*mousedev,<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes">&nbsp;&nbsp; </span><span style="color:blue">struct</span>
mousedev_client *client)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_lock(&amp;<b>mousedev-&gt;client_lock</b>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>list_add_tail_rcu(&amp;client-&gt;node,
&amp;mousedev-&gt;client_list);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_unlock(&amp;mousedev-&gt;client_lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>synchronize_rcu();<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:11.0pt;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">例四、</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">int</span> fionbio(<span style="color:blue">struct</span> file *file, <span style="color:blue">int</span>
__user *p)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_lock(&amp;<b>file-&gt;f_lock</b>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">if</span> (nonblock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>file-&gt;f_flags
|= O_NONBLOCK;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">else<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>file-&gt;f_flags
&amp;= ~O_NONBLOCK;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_unlock(&amp;file-&gt;f_lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> 0;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<span style="color:blue"><o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span style="font-size:11.0pt;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">例五、</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">int</span> tc35815_poll(<span style="color:blue">struct</span> napi_struct *napi, <span style="color:blue">int</span>
budget)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_lock(&amp;<b>lp-&gt;rx_lock</b>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_unlock(&amp;lp-&gt;rx_lock);<span style="color:blue"><o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:9.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>......<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">return</span> received;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><b style="mso-bidi-font-weight:normal"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">Linux</span></b><b style="mso-bidi-font-weight:normal"><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">内核中<span lang="EN-US">spinlock</span>的实现<span lang="EN-US"><o:p></o:p></span></span></b></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:21.3pt;
mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;
font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:
新宋体;mso-font-kerning:0pt">最后我们看一下<span lang="EN-US">Linux</span>内核中的<span lang="EN-US">spinlock</span>究竟是怎么实现的。先看数据结构：<span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">typedef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">struct</span> <b>spinlock</b>
{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">union</span> {<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> <b>raw_spinlock </b>rlock;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#ifdef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> CONFIG_DEBUG_LOCK_ALLOC<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#
define</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"> LOCK_PADSIZE (offsetof(<span style="color:blue">struct</span> raw_spinlock, dep_map))<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> {<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>u8
__padding[LOCK_PADSIZE];<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> lockdep_map dep_map;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>};<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#endif<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>};<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">} <b>spinlock_t</b>;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt">显然，如果忽略</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">DEBUG</span><span style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">的需要，则</span><b><span lang="EN-US" style="font-size:12.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">spinlock_t</span></b><span style="font-size:12.0pt;font-family:新宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-bidi-font-weight:bold">实际上就是</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;color:blue;mso-font-kerning:0pt">struct</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <b>raw_spinlock</b></span><span style="font-size:
12.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-bidi-font-weight:bold">。</span><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">typedef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">struct</span> <b>raw_spinlock
</b>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>arch_spinlock_t
</b>raw_lock;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#ifdef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> CONFIG_GENERIC_LOCKBREAK<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">int</span>
break_lock;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#endif<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#ifdef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> CONFIG_DEBUG_SPINLOCK<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">int</span> magic,
owner_cpu;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">void</span> *owner;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#endif<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#ifdef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> CONFIG_DEBUG_LOCK_ALLOC<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">struct</span> lockdep_map dep_map;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#endif<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">} <b>raw_spinlock_t</b>;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:23.25pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">同样，如果忽略</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">DEBUG</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">的需要，也不要</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">LOCKBREAK</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">，</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:
0pt">那么</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;
mso-font-kerning:0pt">struct</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt"> <b>raw_spinlock</b></span><span style="font-size:12.0pt;
line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-bidi-font-weight:
bold">实际上就是</span><b><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">arch_spinlock_t</span></b><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-bidi-font-weight:bold">。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:23.25pt;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-bidi-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">typedef</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> <span style="color:blue">struct</span> <b>arch_spinlock
</b>{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">unsigned</span> <span style="color:blue">int</span> slock;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">} <b>arch_spinlock_t</b>;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:22.5pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">由此可见，</span><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;
mso-font-kerning:0pt">如果忽略</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt">DEBUG</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">和</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">LOCKBREAK</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">的需要，一个<span lang="EN-US">spinlock</span>实际上就是一个无符号整数。<span lang="EN-US"><o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:22.5pt;
line-height:125%;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-bidi-font-family:新宋体;mso-font-kerning:0pt">在内核中，需要定义一个<span lang="EN-US">spinlock</span>时可以这样：</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;color:blue;mso-font-kerning:0pt">#define</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"> DEFINE_SPINLOCK(x)<span style="mso-spacerun:yes">&nbsp; </span>spinlock_t <span style="mso-spacerun:yes">&nbsp;</span>x = __SPIN_LOCK_UNLOCKED(x)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;mso-layout-grid-align:none;text-autospace:none"><span style="font-size:12.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">再看</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">include/linux/spinlock.h</span><span style="font-size:12.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">中</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">spin_lock()</span><span style="font-size:12.0pt;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">的代码：</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;text-indent:24.0pt;
mso-char-indent-count:2.0;mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> <span style="color:blue">inline</span> <span style="color:blue">void</span> spin_lock(spinlock_t *lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>raw_spin_lock(&amp;lock-&gt;rlock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">#define</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> raw_spin_lock(lock)<span style="mso-tab-count:1">&nbsp;&nbsp; </span>_raw_spin_lock(lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">而</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">_raw_spin_lock</span><span style="font-size:12.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">又定义成</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">__raw_spin_lock</span><span style="font-size:12.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">：</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">#define</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> _raw_spin_lock(lock)<span style="mso-spacerun:yes">&nbsp; </span>__raw_spin_lock(lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">下面就是</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">__raw_spin_lock()</span><span style="font-size:12.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">的实现：</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> <span style="color:blue">inline</span> <span style="color:blue">void</span> __raw_spin_lock(raw_spinlock_t *lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>preempt_disable();<span style="mso-spacerun:yes">&nbsp; </span>//</span><span style="font-size:11.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">禁止调度，形成调度禁区。</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>//</span><span style="font-size:11.0pt;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">这个调度禁区要到程序调用</span><span lang="EN-US" style="font-size:
11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">spin_unlock()<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>//</span><span style="font-size:11.0pt;font-family:宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">的时候才会通过</span><span lang="EN-US" style="font-size:11.0pt;
font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">preempt_enable()</span><span style="font-size:11.0pt;font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">加以解除。</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> <o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>spin_acquire(&amp;lock-&gt;dep_map,
0, 0, _RET_IP_);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>LOCK_CONTENDED(lock,
do_raw_spin_trylock, <b style="mso-bidi-font-weight:normal">do_raw_spin_lock</b>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:11.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">这里的宏操作会调用</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">do_raw_spin_trylock ()</span><span style="font-size:12.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">和</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">do_raw_spin_lock()</span><span style="font-size:12.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">，我们看后者：</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> <span style="color:blue">inline</span> <span style="color:blue">void</span> do_raw_spin_lock(raw_spinlock_t *lock)
__acquires(lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>__acquire(lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b style="mso-bidi-font-weight:normal">arch_spin_lock</b>(&amp;lock-&gt;raw_lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">到了</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">arch_spin_lock()</span><span style="font-size:12.0pt;
font-family:宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">，具体的实现就因</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes">CPU</span><span style="font-size:12.0pt;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">而异了。对于</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt;
mso-no-proof:yes">x86</span><span style="font-size:12.0pt;font-family:宋体;
mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">架构是这样：</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> __always_inline <span style="color:blue">void</span>
arch_spin_lock(arch_spinlock_t *lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>__ticket_spin_lock(lock);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">系统中的</span><span lang="EN-US" style="font-size:12.0pt;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">数量小于</span><span lang="EN-US" style="font-size:12.0pt;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">256</span><span style="font-size:12.0pt;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">时，这个函数是这样实现的：</span><span lang="EN-US" style="font-size:12.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">#if</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> (NR_CPUS &lt; 256)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">static</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"> __always_inline <span style="color:blue">void</span>
__ticket_spin_lock(arch_spinlock_t *lock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">{<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue">short</span> inc = 0x0100;<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>asm
<span style="color:blue">volatile</span> (<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>LOCK_PREFIX
<span style="color:#A31515">"<b style="mso-bidi-font-weight:normal">xadd</b>w
%w0, %1\n"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"1:\t"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"cmpb %h0, %b0\n\t"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"je 2f\n\t"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"rep ; nop\n\t"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"movb %1, %b0\n\t"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:green">/* don't need lfence here, because loads are in-order */<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"jmp 1b\n"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#A31515">"2:"<o:p></o:p></span></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>:
<span style="color:#A31515">"+Q"</span> (inc), <span style="color:#A31515">"+m"</span> (lock-&gt;slock)<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>:<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><span style="mso-tab-count:2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>:
<span style="color:#A31515">"memory"</span>, <span style="color:#A31515">"cc"</span>);<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes">}<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt;mso-no-proof:yes"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">#else<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;color:blue;mso-font-kerning:0pt;mso-no-proof:yes">#endif</span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt;mso-no-proof:yes"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">注意这里用了指令</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">XADD</span><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">。当进不了临界区的门时，</span><span lang="EN-US" style="font-size:
12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:
新宋体;mso-font-kerning:0pt">CPU</span><span style="font-size:12.0pt;line-height:
125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">执行的是“</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt;mso-no-proof:yes">rep; nop</span><span style="font-size:
12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;
mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:0pt">”，消磨掉一点点时间后又转回标号</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">1</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">，这就是“</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">spin</span><span style="font-size:12.0pt;line-height:125%;font-family:
新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;
mso-font-kerning:0pt">”的意思。</span><span lang="EN-US" style="font-size:12.0pt;
line-height:125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;
mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">除</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">spin_lock()</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">以外，</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">Linux</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">内核中还有些类似的函数，其中</span><span lang="EN-US" style="font-size:12.0pt;line-height:
125%;font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt">spin_lock_irq()</span><span style="font-size:12.0pt;line-height:125%;
font-family:新宋体;mso-ascii-font-family:&quot;Times New Roman&quot;;mso-hansi-font-family:
&quot;Times New Roman&quot;;mso-font-kerning:0pt">有着特别的重要性。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">spin_lock_bh()<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">spin_lock_irq()<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">spin_lock_nested()<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">spin_lock_irqsave()<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt">spin_lock_irqsave_nested()<o:p></o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;mso-layout-grid-align:
none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;font-family:
&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><o:p>&nbsp;</o:p></span></p>

<p class="MsoNormal" align="left" style="text-align:left;line-height:125%;
mso-layout-grid-align:none;text-autospace:none"><span lang="EN-US" style="font-size:11.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt"><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">可想而知，如果当前线程正在对一个队列进行操作，而某个中断服务程序中也可能会对此队列进行操所，那就应该用</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;font-family:&quot;Times New Roman&quot;;
mso-fareast-font-family:新宋体;mso-font-kerning:0pt">spin_lock_irq()</span><span style="font-size:12.0pt;line-height:125%;font-family:新宋体;mso-ascii-font-family:
&quot;Times New Roman&quot;;mso-hansi-font-family:&quot;Times New Roman&quot;;mso-font-kerning:
0pt">。其它就不多说了。</span><span lang="EN-US" style="font-size:12.0pt;line-height:125%;
font-family:&quot;Times New Roman&quot;;mso-fareast-font-family:新宋体;mso-font-kerning:
0pt"><o:p></o:p></span></p>

</div>




<!--
     FILE ARCHIVED ON 10:57:30 Nov 09, 2017 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 12:46:41 Apr 13, 2022.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 75.778
  exclusion.robots: 0.347
  exclusion.robots.policy: 0.336
  RedisCDXSource: 0.986
  esindex: 0.011
  LoadShardBlock: 55.787 (3)
  PetaboxLoader3.datanode: 79.047 (4)
  CDXLines.iter: 16.307 (3)
  load_resource: 73.416
  PetaboxLoader3.resolve: 31.883
--><div id="react-toast" class="Toaster"><span class="Toaster__manager-top-left" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; top: 0px; left: 0px;"></span><span class="Toaster__manager-top" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; margin: 0px auto; text-align: center; top: 0px; right: 0px; left: 0px;"></span><span class="Toaster__manager-top-right" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; top: 0px; right: 0px;"></span><span class="Toaster__manager-bottom-left" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; bottom: 0px; left: 0px;"></span><span class="Toaster__manager-bottom" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; margin: 0px auto; text-align: center; bottom: 0px; right: 0px; left: 0px;"></span><span class="Toaster__manager-bottom-right" style="max-width: 560px; position: fixed; z-index: 5500; pointer-events: none; bottom: 0px; right: 0px;"></span></div><script src="chrome-extension://gppongmhjkpfnbhagpmjfkannfbllamg/js/js.js"></script></body><div style="all: initial;"><div id="__hcfy__" style="all: initial;"></div></div></html>